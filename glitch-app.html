<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Glitch">
<meta name="theme-color" content="#0c0a12">
<title>Glitch</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@700;800;900&display=swap" rel="stylesheet">
<style>
:root{--a:#ff6b2b;--a2:#a855f7;--bg:#0c0a12;--c:#13111d;--sf:#1c1928;--t:#eae8f0;--d:#7b6f94;--r:#ff4757;--st:env(safe-area-inset-top,0px);--sb:env(safe-area-inset-bottom,0px)}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Rajdhani',sans-serif;background:var(--bg);color:var(--t);min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
input,button,textarea{font-family:inherit}button{cursor:pointer;border:none;background:none}::-webkit-scrollbar{width:0;height:0}
.app{max-width:480px;margin:0 auto;min-height:100dvh;position:relative}
@keyframes fu{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes fi{from{opacity:0}to{opacity:1}}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes pop{0%{transform:scale(.5);opacity:0}60%{transform:scale(1.1)}100%{transform:scale(1);opacity:1}}
@keyframes shimmer{0%{background-position:-400px 0}100%{background-position:400px 0}}
@keyframes pulse{0%,100%{opacity:.4}50%{opacity:.8}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes slideIn{from{opacity:0;transform:translateX(8px)}to{opacity:1;transform:translateX(0)}}
.fu{animation:fu .4s ease both}.fi{animation:fi .3s ease both}
.d1{animation-delay:.05s;opacity:0}.d2{animation-delay:.1s;opacity:0}.d3{animation-delay:.15s;opacity:0}.d4{animation-delay:.2s;opacity:0}.d5{animation-delay:.25s;opacity:0}
.d6{animation-delay:.3s;opacity:0}.d7{animation-delay:.35s;opacity:0}.d8{animation-delay:.4s;opacity:0}

/* Loading screen */
.loading{min-height:100dvh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;background:var(--bg)}
.load-logo{font-family:'Orbitron',sans-serif;font-size:36px;font-weight:900;background:linear-gradient(135deg,#ff6b2b,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:24px}
.load-spin{width:32px;height:32px;border:3px solid var(--sf);border-top-color:var(--a);border-radius:50%;animation:spin .8s linear infinite;margin-bottom:16px}
.load-msg{font-size:14px;color:var(--d);font-weight:600;text-align:center;transition:all .3s}

/* Skeleton loading */
.skel{background:linear-gradient(90deg,var(--sf) 0%,#252233 50%,var(--sf) 100%);background-size:800px 100%;animation:shimmer 1.5s ease infinite;border-radius:8px}
.skel-card{background:var(--c);border-radius:18px;overflow:hidden;border:1px solid #ffffff08;margin-bottom:14px}
.skel-th{width:100%;aspect-ratio:16/9;background:linear-gradient(90deg,var(--sf) 0%,#252233 50%,var(--sf) 100%);background-size:800px 100%;animation:shimmer 1.5s ease infinite}
.skel-line{height:12px;border-radius:6px;margin:8px 14px}
.skel-line.w60{width:60%}.skel-line.w40{width:40%}.skel-line.w80{width:80%}

/* Clip card hover/transition improvements */
.clip{transition:transform .2s ease,box-shadow .2s ease}
.clip:active{transform:scale(.98);box-shadow:0 0 0 1px #ffffff11}
.cth{transition:filter .3s ease}
.cth img{transition:transform .3s ease}
.feed-vid{opacity:0;transition:opacity .4s ease}
.feed-vid.playing{opacity:1}
.feed-play{transition:opacity .3s ease}
.feed-play.hidden{opacity:0;pointer-events:none}

/* Smooth tab transitions */
.tab{transition:all .25s ease}
.tab:active{transform:scale(.95)}

/* Button press effects */
.ca{transition:all .15s ease}
.ca:active{transform:scale(.9)}
.lb:active{transform:scale(.97);filter:brightness(1.1)}

/* AI badge animation */
.ai{animation:slideIn .4s ease both}

/* Bottom nav transition */
.ni{transition:color .2s ease,transform .15s ease}
.ni:active{transform:scale(.9)}

/* Profile avatar glow animation */
@keyframes avGlow{0%,100%{box-shadow:0 0 30px #ff6b2b22}50%{box-shadow:0 0 50px #ff6b2b33,0 0 80px #a855f711}}
.pav{animation:avGlow 3s ease infinite}

/* Toast notification */
.toast{position:fixed;top:calc(16px + var(--st));left:50%;transform:translateX(-50%);background:var(--c);border:1px solid #ffffff15;border-radius:14px;padding:12px 20px;font-size:13px;font-weight:600;z-index:300;animation:fu .3s ease both;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);max-width:320px;text-align:center}
.toast.ok{border-color:#a855f744;color:var(--a2)}.toast.err{border-color:#ff475744;color:var(--r)}
.login{min-height:100dvh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;background:radial-gradient(ellipse at 50% 0%,#a855f70a 0%,transparent 50%),var(--bg)}
.logo{font-family:'Orbitron',sans-serif;font-size:48px;font-weight:900;background:linear-gradient(135deg,#ff6b2b,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.login-sub{font-size:13px;color:var(--d);letter-spacing:4px;text-transform:uppercase;font-weight:600;margin-bottom:40px}
.lcard{width:100%;max-width:380px;background:var(--c);border-radius:20px;border:1px solid #ffffff0a;padding:28px 24px}
.lcard h2{font-size:20px;font-weight:700;text-align:center;margin-bottom:6px}
.lcard p{font-size:13px;color:var(--d);text-align:center;margin-bottom:20px;line-height:1.4}
.linp{width:100%;padding:12px 14px;background:var(--sf);border:1px solid #ffffff11;border-radius:12px;color:var(--t);font-size:13px;outline:none;margin-bottom:10px}
.linp:focus{border-color:var(--a)}.linp::placeholder{color:var(--d)}
.lbl{font-size:11px;color:var(--d);font-weight:600;margin-bottom:4px;display:block}
.lb{display:block;width:100%;padding:15px;border-radius:14px;font-size:15px;font-weight:700;text-align:center;text-decoration:none;transition:all .3s}
.lb:active{transform:scale(.97)}
.lb-x{background:linear-gradient(135deg,#ff6b2b18,#a855f718);border:1px solid #ff6b2b44;color:var(--t);display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:10px}
.lb-x.off{opacity:.3;pointer-events:none}
.lb-d{background:#ffffff06;border:1px solid #ffffff10;color:var(--d);font-size:13px}
.ldiv{display:flex;align-items:center;gap:14px;margin:12px 0;color:var(--d);font-size:11px;font-weight:600;letter-spacing:1px}
.ldiv::before,.ldiv::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,transparent,#ffffff15,transparent)}
.lfeat{display:flex;gap:28px;justify-content:center;margin-top:36px}
.lfi{display:flex;flex-direction:column;align-items:center;gap:6px}
.lfi-i{width:44px;height:44px;border-radius:14px;background:#ff6b2b22;display:flex;align-items:center;justify-content:center;font-size:20px}
.lfi-l{font-size:10px;color:var(--d);font-weight:700;text-transform:uppercase}
.ls{margin-top:12px;padding:10px;border-radius:10px;font-size:12px;text-align:center;display:none;line-height:1.4}
.ls.on{display:block}.ls.info{background:#ff6b2b15;border:1px solid #ff6b2b33;color:var(--a)}.ls.err{background:#ff475715;border:1px solid #ff475533;color:#ff6b6b}.ls.ok{background:#a855f715;border:1px solid #a855f733;color:var(--a2)}
.tb{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;padding-top:calc(10px + var(--st));position:sticky;top:0;background:#0c0a12ee;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);z-index:100;border-bottom:1px solid #ffffff06}
.tb-l{font-family:'Orbitron',sans-serif;font-size:20px;font-weight:900;background:linear-gradient(135deg,#ff6b2b,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.tb-r{display:flex;align-items:center;gap:14px}
.ntf{position:relative;color:var(--d)}.ntf-d{position:absolute;top:-3px;right:-3px;width:14px;height:14px;border-radius:50%;background:var(--r);display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:800;color:#fff}
.avsm{width:30px;height:30px;border-radius:50%;background:var(--sf);display:flex;align-items:center;justify-content:center;font-size:15px;border:1.5px solid #ff6b2b33;overflow:hidden}.avsm img{width:100%;height:100%;object-fit:cover}
.bn{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;display:flex;align-items:flex-start;justify-content:space-around;padding:6px 0;padding-bottom:calc(8px + var(--sb));background:#0c0a12f8;border-top:1px solid #ffffff06;backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);z-index:100}
.ni{display:flex;flex-direction:column;align-items:center;gap:1px;padding:4px 14px;color:var(--d)}.ni.on{color:var(--a)}
.ni-l{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.3px}
.ni-u{width:46px;height:46px;border-radius:15px;background:var(--sf);border:1px solid #ffffff11;display:flex;align-items:center;justify-content:center;margin-top:-12px;color:var(--d)}.ni-u.on{background:var(--a);color:var(--bg);border:none;box-shadow:0 4px 24px #ff6b2b33}
.pg{padding-bottom:calc(76px + var(--sb))}.pt{font-size:22px;font-weight:800;padding:16px 16px 12px}
.tabs{display:flex;gap:6px;padding:14px 16px 8px;overflow-x:auto;scrollbar-width:none}
.tab{padding:7px 18px;border-radius:20px;font-size:13px;font-weight:700;white-space:nowrap;border:1px solid #ffffff0a;background:var(--sf);color:var(--d)}.tab.on{background:var(--a);color:var(--bg);border-color:var(--a)}
.feed{display:flex;flex-direction:column;gap:0;padding:0;scroll-snap-type:y mandatory;overflow-y:auto;height:100dvh;scroll-behavior:smooth;-webkit-overflow-scrolling:touch}
.snap-item{position:relative;width:100%;height:100dvh;flex-shrink:0;scroll-snap-align:start;scroll-snap-stop:always;overflow:hidden;display:flex;align-items:center;justify-content:center;background-size:cover;background-position:center}
.snap-vid{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;background:#000;transform:scale(1.15);transform-origin:center center}
.snap-overlay{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:flex-end;background:linear-gradient(180deg,#0006 0%,transparent 20%,transparent 50%,#000a 100%);padding:16px;padding-bottom:calc(72px + var(--sb));pointer-events:none}
.snap-overlay *{pointer-events:auto}
.snap-top{position:absolute;top:calc(14px + var(--st) + 44px);left:16px}
.snap-user{display:flex;align-items:center;gap:8px}
.snap-bot{padding-right:60px}
.snap-title{font-size:16px;font-weight:700;text-shadow:0 1px 6px #000a;line-height:1.3}
.snap-acts{position:absolute;right:12px;bottom:calc(90px + var(--sb));display:flex;flex-direction:column;align-items:center;gap:20px;z-index:2}
.snap-act{display:flex;flex-direction:column;align-items:center;gap:2px;color:#fff;font-size:12px;font-weight:700;text-shadow:0 1px 3px #0008}
.snap-act svg{filter:drop-shadow(0 1px 3px #0008)}
.snap-act span{font-size:11px}
.snap-pause{position:absolute;inset:0;z-index:1}
@keyframes pauseIcon{0%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-50%) scale(1.5)}}
.snap-pause-icon{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:64px;height:64px;border-radius:50%;background:#0009;display:flex;align-items:center;justify-content:center;animation:pauseIcon .6s ease forwards}
.clip{background:var(--c);border-radius:18px;overflow:hidden;border:1px solid #ffffff08}.clip:active{transform:scale(.985)}
.cth{position:relative;width:100%;aspect-ratio:16/9;display:flex;align-items:center;justify-content:center;overflow:hidden;background-size:cover;background-position:center}
.cpl{position:absolute;width:56px;height:56px;border-radius:50%;background:#00000077;backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;padding-left:3px;opacity:.8}
.cdur{position:absolute;bottom:8px;right:8px;background:#000b;border-radius:6px;padding:2px 8px;font-size:12px;font-weight:700;color:#fff}
.cac{position:absolute;top:8px;left:8px;background:#a855f722;border:1px solid #a855f744;border-radius:6px;padding:2px 8px;font-size:10px;font-weight:700;color:var(--a2);display:flex;align-items:center;gap:4px;backdrop-filter:blur(6px)}
.cvw{position:absolute;bottom:8px;left:8px;display:flex;align-items:center;gap:4px;font-size:11px;color:#fffc;background:#0006;border-radius:6px;padding:2px 8px}
.cbd{padding:12px 14px 14px}.chd{display:flex;align-items:flex-start;justify-content:space-between;gap:8px}
.cur{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.cav{width:28px;height:28px;border-radius:50%;background:var(--sf);display:flex;align-items:center;justify-content:center;font-size:14px;border:1px solid #ffffff11;flex-shrink:0;overflow:hidden}.cav img{width:100%;height:100%;object-fit:cover}
.cun{font-size:13px;font-weight:700}.ctm{font-size:11px;color:var(--d)}.ctt{font-size:15px;font-weight:700;margin-bottom:5px;line-height:1.2}
.cgm{font-size:11px;color:var(--d);font-weight:600;background:var(--sf);border-radius:6px;padding:2px 8px;display:inline-block}
.ai{display:inline-flex;align-items:center;gap:4px;border-radius:20px;padding:3px 10px 3px 6px;font-size:11px;font-weight:700;letter-spacing:.5px;white-space:nowrap;flex-shrink:0}
.ai.s3{background:#ff475722;border:1px solid #ff475755;color:var(--r)}.ai.s2{background:#a855f722;border:1px solid #a855f755;color:var(--a2)}.ai.s1{background:#ff6b2b22;border:1px solid #ff6b2b55;color:var(--a)}
.cas{display:flex;align-items:center;gap:18px;margin-top:12px;padding-top:10px;border-top:1px solid #ffffff08}
.ca{display:flex;align-items:center;gap:5px;color:var(--d);font-size:13px;font-weight:600;padding:0}.ca.lk{color:var(--r)}
.sb{display:flex;align-items:center;gap:10px;background:var(--sf);border-radius:14px;padding:11px 14px;margin:0 16px 14px;border:1px solid #ffffff08}
.sb input{flex:1;background:none;border:none;outline:none;color:var(--t);font-size:14px}.sb input::placeholder{color:var(--d)}
.uc{display:flex;align-items:center;gap:12px;background:var(--c);border-radius:14px;padding:12px 14px;margin:0 16px 8px;border:1px solid #ffffff08}
.uav{width:46px;height:46px;border-radius:50%;background:var(--sf);display:flex;align-items:center;justify-content:center;font-size:22px;border:2px solid #ffffff11;flex-shrink:0}.uav.fl{border-color:#a855f733}
.ui{flex:1;min-width:0}.unr{display:flex;align-items:center;gap:6px}
.un{font-size:15px;font-weight:700}.xb{font-size:9px;font-weight:800;padding:1px 6px;border-radius:4px;letter-spacing:.5px;color:#107c10;background:#107c1022}
.ut{font-size:12px;color:var(--d)}.us{font-size:11px;color:var(--d);margin-top:2px}
.fb{padding:8px 18px;border-radius:10px;font-size:13px;font-weight:700;flex-shrink:0}.fb.fl{background:transparent;border:1px solid #a855f733;color:var(--a2)}.fb.nf{background:var(--a);color:var(--bg)}
.ph{background:linear-gradient(180deg,#a855f711 0%,transparent 100%);padding:28px 16px 16px;text-align:center}
.pav{width:84px;height:84px;border-radius:50%;margin:0 auto 12px;background:var(--sf);display:flex;align-items:center;justify-content:center;font-size:42px;border:3px solid #ff6b2b33;box-shadow:0 0 40px #ff6b2b22;overflow:hidden}.pav img{width:100%;height:100%;object-fit:cover}
.pnm{font-size:26px;font-weight:800}
.ptg{font-size:13px;color:var(--d);display:flex;align-items:center;justify-content:center;gap:6px;margin-top:4px}
.pss{display:flex;justify-content:center;gap:36px;margin-top:20px}
.pv{font-size:22px;font-weight:800}.pl{font-size:11px;color:var(--d);font-weight:600}
.ptabs{display:flex;border-bottom:1px solid #ffffff0a;padding:0 16px}
.ptb{flex:1;padding:12px 0;text-align:center;font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--d);border-bottom:2px solid transparent}.ptb.on{color:var(--t);border-bottom-color:var(--a)}
.sg{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:16px}
.sc{background:var(--c);border-radius:14px;padding:16px 14px;border:1px solid #ffffff08}
.sci{font-size:22px;margin-bottom:6px}.scv{font-size:20px;font-weight:800}.scl{font-size:11px;color:var(--d);font-weight:600}
.mt{display:flex;background:var(--sf);border-radius:14px;padding:4px;margin:0 16px 20px}
.mb{flex:1;padding:10px 0;border-radius:11px;font-size:14px;font-weight:700;color:var(--d)}.mb.on{background:var(--a);color:var(--bg)}
.syc{background:var(--c);border-radius:18px;padding:22px;margin:0 16px 14px;border:1px solid #ff6b2b33}
.syh{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.syi{width:44px;height:44px;border-radius:12px;background:#a855f722;display:flex;align-items:center;justify-content:center;font-size:20px}
.syt{font-size:16px;font-weight:700}.syd{font-size:12px;color:var(--d)}
.bsy{width:100%;padding:12px;border-radius:12px;background:var(--a);color:var(--bg);font-size:14px;font-weight:700}.bsy:active{transform:scale(.97)}
.pbr{height:8px;border-radius:4px;background:var(--sf);overflow:hidden;margin-bottom:8px}
.pfl{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--a),var(--a2))}
.aic{background:var(--c);border-radius:18px;padding:20px;margin:0 16px;border:1px solid #ffffff08}
.ait{font-size:16px;font-weight:700;margin-bottom:14px}
.air{display:flex;align-items:center;justify-content:space-between;padding:11px 0;border-bottom:1px solid #ffffff06}.air:last-child{border-bottom:none}
.ail{font-size:13px;font-weight:500;flex:1}
.tg{width:44px;height:24px;border-radius:12px;position:relative;flex-shrink:0}.tg.on{background:var(--a)}.tg.off{background:var(--sf);border:1px solid #ffffff11}
.tgk{width:18px;height:18px;border-radius:50%;background:#fff;position:absolute;top:3px;box-shadow:0 1px 3px rgba(0,0,0,.3)}.tg.on .tgk{left:23px}.tg.off .tgk{left:3px}
.mo{position:fixed;inset:0;background:#000d;z-index:200;display:flex;flex-direction:column;animation:fi .2s ease}
.mc{flex:1;max-width:480px;width:100%;margin:0 auto;background:var(--bg);display:flex;flex-direction:column;animation:su .3s ease;overflow-y:auto}
.mx{position:absolute;top:12px;right:12px;width:36px;height:36px;border-radius:50%;background:#000a;color:#fff;display:flex;align-items:center;justify-content:center;z-index:10}
.cs{padding:16px}.cr{display:flex;gap:10px;margin-top:14px;padding-top:14px;border-top:1px solid #ffffff08}
.ci2{flex:1;padding:10px 14px;background:var(--sf);border:1px solid #ffffff08;border-radius:20px;color:var(--t);font-size:13px;outline:none}.ci2:focus{border-color:#ff6b2b33}
.csb{padding:10px 18px;background:var(--a);color:var(--bg);border-radius:20px;font-size:13px;font-weight:700}
.cmi{display:flex;gap:10px;padding:10px 0}
.cmav{width:32px;height:32px;border-radius:50%;background:var(--sf);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.cmn{font-size:13px;font-weight:700}.cmt2{font-size:13px;color:var(--d);line-height:1.4;margin-top:2px}.cmtm{font-size:10px;color:var(--d);margin-top:3px}
.em{text-align:center;padding:40px 24px;color:var(--d)}.emi{font-size:44px;margin-bottom:12px}.emt{font-size:16px;font-weight:700;color:var(--t)}.emd{font-size:13px;margin-top:4px}
.gt{display:flex;flex-wrap:wrap;gap:8px;padding:0 16px}.gti{background:var(--c);border-radius:10px;padding:8px 14px;border:1px solid #ffffff08;font-size:13px;font-weight:600;color:var(--t)}
.lr{display:flex;align-items:center;gap:12px;padding:10px 16px;border-bottom:1px solid #ffffff05}
.lrk{font-size:16px;font-weight:800;color:var(--a2);width:26px;text-align:center}
.lra{width:38px;height:38px;border-radius:50%;background:var(--sf);display:flex;align-items:center;justify-content:center;font-size:18px}
.stt{font-size:13px;font-weight:700;color:var(--d);letter-spacing:1px;padding:0 16px;margin-bottom:10px;margin-top:20px}
.cli{display:flex;gap:12px;background:var(--c);border-radius:12px;overflow:hidden;margin:0 16px 8px;border:1px solid #ffffff08}
.clt{width:130px;min-height:74px;flex-shrink:0;position:relative;background-size:cover;background-position:center}
.clif{padding:10px 12px 10px 0;flex:1;min-width:0}
.cltt{font-size:14px;font-weight:700;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.clm{font-size:11px;color:var(--d)}

/* Pull to refresh */
.ptr{position:fixed;top:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;z-index:102;text-align:center;padding:16px 0 12px;opacity:0;transform:translateX(-50%) translateY(-100%);transition:transform .3s ease,opacity .3s ease;pointer-events:none}
.ptr.show{opacity:1;transform:translateX(-50%) translateY(0)}
.ptr-inner{display:inline-flex;align-items:center;gap:8px;background:var(--c);border:1px solid #ffffff15;border-radius:20px;padding:8px 18px;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
.ptr-spin{display:inline-block;width:18px;height:18px;border:2px solid #ffffff22;border-top-color:var(--a);border-radius:50%;animation:spin .8s linear infinite}
.ptr-txt{font-size:12px;font-weight:700;color:var(--d)}

/* Double-tap heart */
@keyframes dtHeart{0%{opacity:1;transform:translate(-50%,-50%) scale(0)}15%{transform:translate(-50%,-50%) scale(1.3)}30%{transform:translate(-50%,-50%) scale(1)}80%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-50%) scale(1.5)}}
.dt-heart{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:5;animation:dtHeart .9s ease forwards;filter:drop-shadow(0 4px 12px #0008)}

/* Mute toggle in modal */
.mute-btn{position:absolute;bottom:12px;right:12px;width:36px;height:36px;border-radius:50%;background:#000a;color:#fff;display:flex;align-items:center;justify-content:center;z-index:10;backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);transition:background .2s}
.mute-btn:active{background:#fff3}
</style>
</head>
<body>
<div id="app" class="app"></div>
<script>
/*
 * GLITCH — Auth Flow (Implicit Grant via MSAL endpoint)
 *
 * 1. User clicks "Sign in with Xbox"
 * 2. Redirects to Microsoft login with response_type=token (implicit flow)
 * 3. Microsoft returns access_token directly in URL hash — NO code exchange needed
 * 4. App reads token from hash
 * 5. Uses PROXY for Xbox Live auth chain (XBL → XSTS → Profile → Clips)
 *
 * This eliminates the token exchange step entirely.
 * App must be registered as SPA in Azure (which it already is).
 */
var G={
REDIR:location.origin+location.pathname,
ic:function(n,z){z=z||20;var m={
home:'<svg width="'+z+'" height="'+z+'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
search:'<svg width="'+z+'" height="'+z+'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
upload:'<svg width="'+z+'" height="'+z+'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',
friends:'<svg width="'+z+'" height="'+z+'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
profile:'<svg width="'+z+'" height="'+z+'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
heart:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
heartF:'<svg width="18" height="18" viewBox="0 0 24 24" fill="#ff4757" stroke="#ff4757" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
cmt:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
share:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>',
play:'<svg width="32" height="32" viewBox="0 0 24 24" fill="white"><polygon points="5 3 19 12 5 21 5 3"/></svg>',
zap:'<svg width="14" height="14" viewBox="0 0 24 24" fill="var(--a)" stroke="var(--a)" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
bell:'<svg width="'+z+'" height="'+z+'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>',
x:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
eye:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
chk:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>',
out:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>'
};return m[n]||''},

USERS:[{id:1,un:"xNightHawk",gt:"xNightHawk#2847",av:"\u{1F985}",frs:1243,fg:89,cl:47},{id:2,un:"FragMaster99",gt:"FragMaster99",av:"\u{1F480}",frs:892,fg:134,cl:31},{id:3,un:"SilentScope",gt:"SilentScope_X",av:"\u{1F3AF}",frs:2301,fg:201,cl:63},{id:4,un:"VelocityKing",gt:"VelocityKing",av:"\u{26A1}",frs:567,fg:78,cl:22},{id:5,un:"LunarWraith",gt:"LunarWraith#1001",av:"\u{1F319}",frs:3102,fg:156,cl:89},{id:6,un:"BlazeRunner",gt:"BlazeRunner_TV",av:"\u{1F525}",frs:445,fg:62,cl:18}],
GAMES:["Fortnite","Call of Duty","ARC Raiders","Minecraft","Roblox","GTA Online","Apex Legends","Rocket League","Overwatch 2","Halo Infinite"],
TYPES:["Squad Wipe","Clutch Round","Insane Snipe","Ace","Trickshot","Collateral","1v4 Clutch","No-Scope","Team Play","Buzzer Beater"],
DCMTS:[{u:{av:"\u{1F480}",n:"FragMaster99"},t:"Absolutely filthy \u{1F525}",tm:"2m"},{u:{av:"\u{1F3AF}",n:"SilentScope"},t:"How do you hit those lol",tm:"8m"},{u:{av:"\u{26A1}",n:"VelocityKing"},t:"Bro I was in this lobby",tm:"14m"}],
HUES:[[200,260],[340,20],[140,200],[260,320],[20,80],[180,240],[300,360],[100,160],[220,280],[40,100]],

st:{screen:'login',page:'feed',user:null,clips:[],liked:new Set(),following:new Set([2,3,5]),comments:{},filter:'all clips',upMode:'auto',pTab:'clips',fTab:'friends',fSearch:'',syncProg:-1,selClip:null,newCmt:'',aiSet:[1,1,1,0,0],clipsLoading:false,loadMsg:'',dsLoading:false,dsResults:null,dsError:null,dsQuery:'',sugFriends:null,sugFrLoading:false,gpGame:null,gpLoading:false,gpClips:null,gpError:null,titleMap:{}},
sv:function(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}},
ld:function(k){try{var v=localStorage.getItem(k);return v?JSON.parse(v):null}catch(e){return null}},
svLikes:function(){this.sv('glitch_likes',Array.from(this.st.liked))},
svFollows:function(){this.sv('glitch_follows',Array.from(this.st.following))},
svClips:function(){try{this.sv('glitch_clips',this.st.clips.slice(0,30))}catch(e){}},
// Build titleMap from raw Xbox API gameClips array
_buildTitleMap:function(gameClips){
  var self=this;
  if(!gameClips||!Array.isArray(gameClips))return;
  gameClips.forEach(function(c){
    var tid=c.titleId||c.TitleId;
    var tn=c.titleName||c.TitleName;
    if(tid&&tn)self.st.titleMap[tn.toLowerCase()]=tid;
  });
  console.log('[TitleMap] Built from',gameClips.length,'clips:',JSON.parse(JSON.stringify(self.st.titleMap)));
},
restoreSocial:function(){var l=this.ld('glitch_likes'),f=this.ld('glitch_follows');if(l)this.st.liked=new Set(l);if(f)this.st.following=new Set(f)},
tg:function(s){var h=this.HUES[s%10];return'linear-gradient(135deg,hsl('+h[0]+',70%,20%),hsl('+h[1]+',80%,15%))'},
aib:function(s){return'<span class="ai '+(s>=90?'s3':s>=75?'s2':'s1')+'">'+this.ic('zap',14)+' '+s+' \u00b7 '+(s>=90?'INSANE':s>=75?'FIRE':'NICE')+'</span>'},
genClips:function(){var c=[];for(var i=0;i<20;i++){var u=this.USERS[~~(Math.random()*6)],g=this.GAMES[~~(Math.random()*10)],t=this.TYPES[~~(Math.random()*10)],sc=~~(Math.random()*40)+60,m=~~(Math.random()*1440);c.push({id:i+1,user:u,game:g,type:t,title:t+' on '+g,ai:sc,lk:~~(Math.random()*500)+10,cm:~~(Math.random()*80),sh:~~(Math.random()*40),vw:~~(Math.random()*5000)+100,dur:'0:'+String(~~(Math.random()*45)+5).padStart(2,'0'),ago:m<60?m+'m':m<1440?~~(m/60)+'h':~~(m/1440)+'d',auto:Math.random()>.3,sd:i})}this.st.clips=c.sort(function(a,b){return b.ai-a.ai})},

// === AUTH: Implicit flow — token comes back in URL hash, no exchange needed ===
px:function(url,opts){
  var proxy=localStorage.getItem('glitch_proxy');
  var shortUrl=url.replace('https://','').split('?')[0];
  return fetch(proxy+'/api/xbox',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url:url,method:opts.method||'GET',headers:opts.headers||{},body:opts.body||undefined})}).then(function(r){return r.json().then(function(j){console.log('[PROXY]',shortUrl,'→',j.ok?'OK':'FAIL',j);return j})});
},

startLogin:function(){
  // Hardcoded — users don't need to configure anything
  var cid='c693c828-6bb7-43dc-a222-44d6e73c1130',proxy='https://glitch-proxy-sand.vercel.app';
  localStorage.setItem('glitch_cid',cid);
  localStorage.setItem('glitch_proxy',proxy);
  location.href='https://login.microsoftonline.com/consumers/oauth2/v2.0/authorize'
    +'?client_id='+encodeURIComponent(cid)
    +'&response_type=token'
    +'&redirect_uri='+encodeURIComponent(this.REDIR)
    +'&scope='+encodeURIComponent('Xboxlive.signin Xboxlive.offline_access')
    +'&response_mode=fragment'
    +'&nonce='+Date.now();
},

handleAuth:function(token){
  var self=this;
  self.st.screen='loading';self.st.loadMsg='Connecting to Xbox Live...';self.render();
  console.log('Got MS token, starting Xbox auth chain...');

  // Step 1: MS token -> XBL token (PROXY)
  self.px('https://user.auth.xboxlive.com/user/authenticate',{method:'POST',headers:{'Content-Type':'application/json'},body:{RelyingParty:'http://auth.xboxlive.com',TokenType:'JWT',Properties:{AuthMethod:'RPS',SiteName:'user.auth.xboxlive.com',RpsTicket:'d='+token}}})
  .then(function(r){
    if(!r.ok)throw new Error('XBL: '+JSON.stringify(r.data));
    var tk=r.data.Token,uh=r.data.DisplayClaims.xui[0].uhs;
    console.log('Step 1: Got XBL token');self.st.loadMsg='Authorizing...';self.render();

    // Step 2: XBL -> XSTS (PROXY)
    return self.px('https://xsts.auth.xboxlive.com/xsts/authorize',{method:'POST',headers:{'Content-Type':'application/json'},body:{RelyingParty:'http://xboxlive.com',TokenType:'JWT',Properties:{SandboxId:'RETAIL',UserTokens:[tk]}}}).then(function(r2){
      if(!r2.ok)throw new Error('XSTS: '+JSON.stringify(r2.data));
      console.log('Step 2: Got XSTS token');return{uh:uh,xt:r2.data.Token};
    });
  })
  .then(function(auth){
    self.st.loadMsg='Loading your profile...';self.render();
    // Step 3: Profile (PROXY)
    return self.px('https://profile.xboxlive.com/users/me/profile/settings?settings=Gamertag,GameDisplayPicRaw,Gamerscore',{method:'GET',headers:{'Authorization':'XBL3.0 x='+auth.uh+';'+auth.xt,'x-xbl-contract-version':'2','Content-Type':'application/json'}}).then(function(r){
      if(!r.ok)throw new Error('Profile: '+JSON.stringify(r.data));
      console.log('Step 3: Got profile');return{p:r.data,a:auth};
    });
  })
  .then(function(res){
    var s={},xuid=res.p.profileUsers[0].id||'';res.p.profileUsers[0].settings.forEach(function(x){s[x.id]=x.value});
    self.st.user={id:0,un:s.Gamertag||'Player',gt:s.Gamertag||'Player',av:'\u{1F3AE}',avUrl:s.GameDisplayPicRaw||null,frs:0,fg:0,cl:0,gs:s.Gamerscore||'0',xuid:xuid};
    self.st.screen='main';
    self.sv('glitch_sess',{user:self.st.user});
    self.sv('glitch_xauth',{uh:res.a.uh,xt:res.a.xt,xid:xuid});
    console.log('SUCCESS: Logged in as',s.Gamertag);
    self.st.clips=[];self.st.clipsLoading=true;self.render();
    self.toast('Welcome, '+(s.Gamertag||'Player')+'! \u{1F3AE}','ok',3000);

    // Step 4: Clips (PROXY, optional)
    self.px('https://gameclipsmetadata.xboxlive.com/users/me/clips',{method:'GET',headers:{'Authorization':'XBL3.0 x='+res.a.uh+';'+res.a.xt,'x-xbl-contract-version':'1'}}).then(function(r){
      if(r.ok&&r.data&&r.data.gameClips){
        self._buildTitleMap(r.data.gameClips);
        var rc=r.data.gameClips.map(function(c,i){return{id:2000+i,user:self.st.user,game:c.titleName||'Unknown',type:c.type||'Clip',title:c.clipName||c.titleName||'Gameplay',ai:self.scoreClip(c),lk:0,cm:0,sh:0,vw:c.views||0,dur:~~(c.durationInSeconds/60)+':'+String(~~(c.durationInSeconds%60)).padStart(2,'0'),ago:self.fmA(new Date(c.dateRecorded)),auto:c.type!=='UserGenerated',sd:i,thUrl:c.thumbnails&&c.thumbnails[0]?c.thumbnails[0].uri:null,vidUrl:c.gameClipUris&&c.gameClipUris[0]?c.gameClipUris[0].uri:null}});
        self.st.clips=rc;self.st.user.cl=rc.length;self.st.clipsLoading=false;self.svClips();self.sv('glitch_sess',{user:self.st.user});console.log('Loaded',rc.length,'real clips');self.render();
      } else { self.st.clipsLoading=false;self.render(); }
    }).catch(function(e){console.log('Clips optional:',e);self.st.clipsLoading=false;self.render()});
  })
  .catch(function(e){console.error('Auth failed:',e.message);self.st.loadMsg='Something went wrong. Loading demo...';self.render();setTimeout(function(){self.demoFB()},3000)});
},

fmA:function(d){var m=~~((Date.now()-d.getTime())/60000);return m<60?m+'m':m<1440?~~(m/60)+'h':~~(m/1440)+'d'},

// Smart AI scoring based on clip metadata
scoreClip:function(c){
  var score=50,title=((c.clipName||c.ClipName||'')+(c.titleName||c.TitleName||'')).toLowerCase(),dur=c.durationInSeconds||c.DurationInSeconds||30;
  // Duration scoring: sweet spot is 10-30s (highlights), very short or very long = lower
  if(dur>=5&&dur<=15)score+=15;else if(dur>15&&dur<=30)score+=12;else if(dur>30&&dur<=60)score+=6;else score+=2;
  // Game tier: competitive/action games score higher
  var tier1=['call of duty','halo','apex','overwatch','fortnite','valorant','rainbow six','destiny','gears','battlefield','counter-strike','pubg','warzone','arc raiders'];
  var tier2=['rocket league','fifa','nba','madden','ufc','gran turismo','forza','street fighter','mortal kombat'];
  var tier3=['gta','red dead','minecraft','roblox','diablo','elden ring','zelda','final fantasy','cyberpunk','starfield','hogwarts'];
  var gn=(c.titleName||c.TitleName||'').toLowerCase();
  if(tier1.some(function(g){return gn.indexOf(g)!==-1}))score+=12;
  else if(tier2.some(function(g){return gn.indexOf(g)!==-1}))score+=8;
  else if(tier3.some(function(g){return gn.indexOf(g)!==-1}))score+=5;
  else score+=3;
  // Title keywords: action words boost score
  var hot=['kill','multi','triple','quad','penta','ace','clutch','wipe','squad','snipe','headshot','collateral','noscope','no-scope','trickshot','trick','win','victory','champion','mvp','record','insane','crazy','epic','best','impossible','unbelievable','1v'];
  var warm=['save','goal','assist','defend','capture','streak','spree','combo','finish','final','overtime','last','buzzer','comeback'];
  var hitHot=0,hitWarm=0;
  hot.forEach(function(k){if(title.indexOf(k)!==-1)hitHot++});
  warm.forEach(function(k){if(title.indexOf(k)!==-1)hitWarm++});
  score+=Math.min(hitHot*8,20)+Math.min(hitWarm*4,12);
  // Views boost (if Xbox provides them)
  var vw=c.views||c.Views||0;
  if(vw>100)score+=5;if(vw>500)score+=5;if(vw>1000)score+=5;
  // User-saved clips (not auto) might be more intentional
  if((c.type||c.Type)==='UserGenerated')score+=5;
  // Clamp to 1-99
  return Math.max(1,Math.min(99,score));
},
demoFB:function(){this.st.user={id:0,un:'DemoPlayer',gt:'Demo Mode',av:'\u{1F3AE}',frs:1243,fg:89,cl:47};this.st.screen='main';this.sv('glitch_sess',{user:this.st.user,demo:1});this.genClips();this.render()},
setSt:function(m,t){var el=document.getElementById('ls');if(el){if(this.st.screen==='loading'){el.textContent=m}else{el.className='ls on '+t;el.textContent=m}}},
loginDemo:function(){this.demoFB()},
logout:function(){localStorage.removeItem('glitch_sess');localStorage.removeItem('glitch_xauth');localStorage.removeItem('glitch_clips');this.st.screen='login';this.st.user=null;this.st.clips=[];this.render()},
toggleLike:function(id){var s=this.st.liked;s.has(id)?s.delete(id):s.add(id);this.svLikes();this.render()},
toggleFollow:function(id){var s=this.st.following;s.has(id)?s.delete(id):s.add(id);this.svFollows();this.render()},
toggleAI:function(i){this.st.aiSet[i]=this.st.aiSet[i]?0:1;this.render()},
startSync:function(){var self=this;this.st.syncProg=0;this.render();var iv=setInterval(function(){self.st.syncProg+=Math.random()*12+5;if(self.st.syncProg>=100){self.st.syncProg=100;clearInterval(iv)}self.render()},350)},
addCmt:function(){if(!this.st.newCmt.trim())return;var id=this.st.selClip.id;if(!this.st.comments[id])this.st.comments[id]=[];this.st.comments[id].unshift({u:{av:this.st.user.av,n:this.st.user.un},t:this.st.newCmt.trim(),tm:'now'});this.st.newCmt='';this.render()},

shareClip:function(c){
  var url=this.REDIR,text='Check out this '+c.game+' clip on Glitch! "'+c.title+'" \u2014 AI Score: '+c.ai;
  if(navigator.share){navigator.share({title:'Glitch \u2014 '+c.title,text:text,url:url}).catch(function(){})}
  else{navigator.clipboard.writeText(text+' '+url).then(function(){alert('Link copied!')}).catch(function(){prompt('Copy this link:',url)})}
},

refreshFeed:function(){
  var self=this;
  self._refreshing=true;self.render();
  setTimeout(function(){
    var isDemo=self.st.user&&self.st.user.un==='DemoPlayer';
    if(isDemo){self.genClips()}
    else{
      var auth=self.ld('glitch_xauth');
      if(auth){
        self.px('https://gameclipsmetadata.xboxlive.com/users/me/clips',{method:'GET',headers:{'Authorization':'XBL3.0 x='+auth.uh+';'+auth.xt,'x-xbl-contract-version':'1'}}).then(function(r){
          if(r.ok&&r.data&&r.data.gameClips){
            self._buildTitleMap(r.data.gameClips);
            var rc=r.data.gameClips.map(function(c,i){return{id:2000+i,user:self.st.user,game:c.titleName||'Unknown',type:c.type||'Clip',title:c.clipName||c.titleName||'Gameplay',ai:self.scoreClip(c),lk:0,cm:0,sh:0,vw:c.views||0,dur:~~(c.durationInSeconds/60)+':'+String(~~(c.durationInSeconds%60)).padStart(2,'0'),ago:self.fmA(new Date(c.dateRecorded)),auto:c.type!=='UserGenerated',sd:i,thUrl:c.thumbnails&&c.thumbnails[0]?c.thumbnails[0].uri:null,vidUrl:c.gameClipUris&&c.gameClipUris[0]?c.gameClipUris[0].uri:null}});
            self.st.clips=rc;self.st.user.cl=rc.length;self.svClips();
          }
          self._refreshing=false;self.render();self.toast('Feed refreshed','ok',1500);
        }).catch(function(){self._refreshing=false;self.render()});
        return;
      }
    }
    self._refreshing=false;self.render();self.toast('Feed refreshed','ok',1500);
  },800);
},

shareApp:function(){
  var url=this.REDIR,text='Join me on Glitch \u2014 an AI-powered game clip app for Xbox players! Sign in with your Xbox account to share and score your best plays.';
  if(navigator.share){navigator.share({title:'Join Glitch',text:text,url:url}).catch(function(){})}
  else{navigator.clipboard.writeText(text+' '+url).then(function(){alert('Invite link copied!')}).catch(function(){prompt('Copy this link:',url)})}
},

// Search any Xbox gamertag and load their public clips
searchGamertag:function(gt){
  var self=this,auth=this.ld('glitch_xauth');
  if(!auth){self.toast('Sign in with Xbox first','err');return}
  self.st.dsLoading=true;self.st.dsResults=null;self.st.dsError=null;self.st.dsQuery=gt;self.render();

  // Step 1: Look up XUID by gamertag
  self.px('https://profile.xboxlive.com/users/gt('+encodeURIComponent(gt)+')/profile/settings?settings=Gamertag,GameDisplayPicRaw,Gamerscore',{method:'GET',headers:{'Authorization':'XBL3.0 x='+auth.uh+';'+auth.xt,'x-xbl-contract-version':'2','Content-Type':'application/json'}})
  .then(function(r){
    if(!r.ok)throw new Error('not_found');
    var pu=r.data.profileUsers[0],sets={};pu.settings.forEach(function(x){sets[x.id]=x.value});
    var xuid=pu.id,user={id:'x_'+xuid,un:sets.Gamertag||gt,gt:sets.Gamertag||gt,av:'\u{1F3AE}',avUrl:sets.GameDisplayPicRaw||null,gs:sets.Gamerscore||'0'};
    console.log('Found user:',user.un,'XUID:',xuid);

    // Step 2: Get their clips
    return self.px('https://gameclipsmetadata.xboxlive.com/users/xuid('+xuid+')/clips',{method:'GET',headers:{'Authorization':'XBL3.0 x='+auth.uh+';'+auth.xt,'x-xbl-contract-version':'1'}}).then(function(r2){
      var clips=[];
      if(r2.ok&&r2.data&&r2.data.gameClips){
        clips=r2.data.gameClips.map(function(c,i){return{id:5000+i,user:user,game:c.titleName||'Unknown',type:c.type||'Clip',title:c.clipName||c.titleName||'Gameplay',ai:self.scoreClip(c),lk:0,cm:0,sh:0,vw:c.views||0,dur:~~(c.durationInSeconds/60)+':'+String(~~(c.durationInSeconds%60)).padStart(2,'0'),ago:self.fmA(new Date(c.dateRecorded)),auto:c.type!=='UserGenerated',sd:i,thUrl:c.thumbnails&&c.thumbnails[0]?c.thumbnails[0].uri:null,vidUrl:c.gameClipUris&&c.gameClipUris[0]?c.gameClipUris[0].uri:null}});
      }
      self.st.dsLoading=false;self.st.dsResults={user:user,clips:clips};self.render();
    });
  })
  .catch(function(e){
    console.log('Search error:',e);
    self.st.dsLoading=false;self.st.dsError=e.message==='not_found'?'Gamertag "'+gt+'" not found. Check the spelling and try again.':'Search failed: '+e.message;
    self.render();
  });
},

// Friends page gamertag search (reuses same Xbox API as Discover)
searchFriend:function(gt){
  var self=this,auth=this.ld('glitch_xauth');
  if(!auth){self.toast('Sign in with Xbox first','err');return}
  self.st.frLoading=true;self.st.frResult=null;self.st.frError=null;self.st.frQuery=gt;self.render();
  self.px('https://profile.xboxlive.com/users/gt('+encodeURIComponent(gt)+')/profile/settings?settings=Gamertag,GameDisplayPicRaw,Gamerscore',{method:'GET',headers:{'Authorization':'XBL3.0 x='+auth.uh+';'+auth.xt,'x-xbl-contract-version':'2','Content-Type':'application/json'}})
  .then(function(r){
    if(!r.ok)throw new Error('not_found');
    var pu=r.data.profileUsers[0],sets={};pu.settings.forEach(function(x){sets[x.id]=x.value});
    var xuid=pu.id,user={id:'f_'+xuid,un:sets.Gamertag||gt,gt:sets.Gamertag||gt,av:'\u{1F3AE}',avUrl:sets.GameDisplayPicRaw||null,gs:sets.Gamerscore||'0'};
    return self.px('https://gameclipsmetadata.xboxlive.com/users/xuid('+xuid+')/clips',{method:'GET',headers:{'Authorization':'XBL3.0 x='+auth.uh+';'+auth.xt,'x-xbl-contract-version':'1'}}).then(function(r2){
      var clips=[];
      if(r2.ok&&r2.data&&r2.data.gameClips){clips=r2.data.gameClips.map(function(c,i){return{id:7000+i,user:user,game:c.titleName||'Unknown',type:c.type||'Clip',title:c.clipName||c.titleName||'Gameplay',ai:self.scoreClip(c),lk:0,cm:0,sh:0,vw:c.views||0,dur:~~(c.durationInSeconds/60)+':'+String(~~(c.durationInSeconds%60)).padStart(2,'0'),ago:self.fmA(new Date(c.dateRecorded)),auto:c.type!=='UserGenerated',sd:i,thUrl:c.thumbnails&&c.thumbnails[0]?c.thumbnails[0].uri:null,vidUrl:c.gameClipUris&&c.gameClipUris[0]?c.gameClipUris[0].uri:null}})}
      self.st.frLoading=false;self.st.frResult={user:user,clips:clips};self.render();
    });
  })
  .catch(function(e){self.st.frLoading=false;self.st.frError=e.message==='not_found'?'Gamertag "'+gt+'" not found.':'Search failed: '+e.message;self.render()});
},

// Load Xbox friends list — favorites shown first, then all friends
loadSuggestedFriends:function(){
  var self=this,auth=this.ld('glitch_xauth');
  if(!auth){self.st.sugFriends=[];return}
  self.st.sugFrLoading=true;self.render();
  // Fetch full friends list from Xbox Social API
  self.px('https://social.xboxlive.com/users/me/people',{method:'GET',headers:{'Authorization':'XBL3.0 x='+auth.uh+';'+auth.xt,'x-xbl-contract-version':'2'}})
  .then(function(r){
    console.log('Friends API response:',r);
    if(r.ok&&r.data){
      var people=r.data.people||r.data.People||[];
      if(!Array.isArray(people)&&r.data.length){people=r.data}
      var all=people.map(function(p){return{xuid:p.xuid||p.Xuid,un:p.gamertag||p.Gamertag||p.displayName||p.DisplayName||'Player',avUrl:p.displayPicRaw||p.DisplayPicRaw||p.displayPic||null,gs:p.gamerScore||p.GamerScore||'0',isFav:!!(p.isFavorite||p.IsFavorite)}});
      // Sort favorites to top
      all.sort(function(a,b){return(b.isFav?1:0)-(a.isFav?1:0)});
      self.st.sugFriends=all;
      console.log('Loaded',all.length,'friends,',all.filter(function(f){return f.isFav}).length,'favorites');
    } else {
      console.log('Friends API: no data or not ok',r);
      self.st.sugFriends=[];
    }
    self.st.sugFrLoading=false;self.render();
  }).catch(function(e){
    console.log('Friends list error:',e);
    self.st.sugFriends=[];self.st.sugFrLoading=false;self.render();
  });
},

// Parse community clips from Xbox API response
_parseGameClips:function(data,gameName){
  if(!data)return[];
  var clips=data.gameClips||data.GameClips||[];
  if(!Array.isArray(clips))return[];
  var self=this;
  return clips.map(function(c,i){
    var user={id:'gp_'+(c.xuid||c.Xuid||i),un:c.gamertag||c.Gamertag||'Xbox Player',gt:c.gamertag||c.Gamertag||'Xbox Player',av:'\u{1F3AE}',avUrl:null,gs:'0'};
    var ths=c.thumbnails||c.Thumbnails||[];var uris=c.gameClipUris||c.GameClipUris||[];
    return{id:8000+i,user:user,game:c.titleName||c.TitleName||gameName,type:c.type||c.Type||'Clip',title:c.clipName||c.ClipName||c.titleName||'Gameplay',ai:self.scoreClip(c),lk:c.likeCount||0,cm:c.commentCount||0,sh:c.shareCount||0,vw:c.views||c.Views||0,dur:~~((c.durationInSeconds||c.DurationInSeconds||0)/60)+':'+String(~~((c.durationInSeconds||c.DurationInSeconds||0)%60)).padStart(2,'0'),ago:self.fmA(new Date(c.dateRecorded||c.DateRecorded||Date.now())),auto:(c.type||c.Type)!=='UserGenerated',sd:i,thUrl:ths.length>0?ths[0].uri||ths[0].Uri:null,vidUrl:uris.length>0?uris[0].uri||uris[0].Uri:null};
  });
},

// Game page: resolve titleId then fetch community clips
openGamePage:function(gameName){
  var self=this,auth=this.ld('glitch_xauth');
  self.st.gpGame=gameName;self.st.gpLoading=true;self.st.gpClips=null;self.st.gpError=null;self.render();
  if(!auth){self.st.gpLoading=false;self.st.gpError='Sign in with Xbox to browse game clips';self.render();return}

  var hdrs={'Authorization':'XBL3.0 x='+auth.uh+';'+auth.xt};
  var gn=gameName.toLowerCase();

  // Helper: merge user's own clips for this game
  var getOwnClips=function(){
    return self.st.clips.filter(function(c){return c.game.toLowerCase().indexOf(gn)!==-1});
  };

  // Helper: finish loading with community + own clips
  var finishWith=function(community){
    var own=getOwnClips();
    self.st.gpClips=own.concat(community);
    self.st.gpLoading=false;
    if(self.st.gpClips.length===0)self.st.gpError='No clips found for '+gameName+'. Try searching for gamertags who play this game!';
    self.render();
  };

  // Helper: try fetching community clips for a given titleId
  var fetchClipsForTitle=function(titleId){
    console.log('Fetching community clips for titleId:',titleId);
    self.px('https://gameclipsmetadata.xboxlive.com/public/titles/'+titleId+'/clips?maxItems=25',{
      method:'GET',headers:Object.assign({},hdrs,{'x-xbl-contract-version':'1'})
    }).then(function(r){
      console.log('Community clips response:',r);
      var community=[];
      if(r&&r.ok&&r.data){community=self._parseGameClips(r.data,gameName)}
      if(community.length>0){finishWith(community);return}
      // Try with qualifier=saved if no results
      self.px('https://gameclipsmetadata.xboxlive.com/public/titles/'+titleId+'/clips?qualifier=saved&maxItems=25',{
        method:'GET',headers:Object.assign({},hdrs,{'x-xbl-contract-version':'1'})
      }).then(function(r2){
        console.log('Community clips (saved) response:',r2);
        if(r2&&r2.ok&&r2.data){community=self._parseGameClips(r2.data,gameName)}
        finishWith(community);
      }).catch(function(){finishWith([])});
    }).catch(function(e){console.log('Clips fetch error:',e);finishWith([])});
  };

  // Step 1: Check titleMap (built from user's own clips) for an exact or partial match
  var titleId=null;
  var mapKeys=Object.keys(self.st.titleMap);
  // Try exact match first
  if(self.st.titleMap[gn])titleId=self.st.titleMap[gn];
  // Try partial match (game name contained in a title, or title contained in game name)
  if(!titleId){for(var i=0;i<mapKeys.length;i++){if(mapKeys[i].indexOf(gn)!==-1||gn.indexOf(mapKeys[i])!==-1){titleId=self.st.titleMap[mapKeys[i]];break}}}

  if(titleId){
    console.log('Found titleId',titleId,'for',gameName,'from clip titleMap');
    fetchClipsForTitle(titleId);
    return;
  }

  // Step 2: Fetch user's title history to find the titleId
  console.log('No cached titleId for',gameName,'- fetching title history...');
  var xuid=auth.xid||(self.st.user&&self.st.user.xuid)||'';
  var thUrl=xuid?'https://titlehub.xboxlive.com/users/xuid('+xuid+')/titles/titlehistory/decoration/image':'https://titlehub.xboxlive.com/users/me/titles/titlehistory/decoration/image';
  self.px(thUrl,{
    method:'GET',headers:Object.assign({},hdrs,{'x-xbl-contract-version':'2'})
  }).then(function(r){
    console.log('Title history response:',r);
    if(r.ok&&r.data){
      var titles=r.data.titles||r.data.Titles||[];
      if(!Array.isArray(titles)){var k=Object.keys(r.data);for(var j=0;j<k.length;j++){if(Array.isArray(r.data[k[j]])){titles=r.data[k[j]];break}}}
      // Cache all titles and find our match
      for(var t=0;t<titles.length;t++){
        var tn=(titles[t].name||titles[t].Name||titles[t].titleName||'').toLowerCase();
        var tid=titles[t].titleId||titles[t].TitleId;
        if(tn&&tid){
          self.st.titleMap[tn]=tid;
          if(!titleId&&(tn.indexOf(gn)!==-1||gn.indexOf(tn)!==-1))titleId=tid;
        }
      }
    }
    if(titleId){
      console.log('Found titleId',titleId,'from title history');
      fetchClipsForTitle(titleId);
    } else {
      console.log('Game not in title history, trying title hub search...');
      // Step 3: Last resort - try title hub search
      self.px('https://titlehub.xboxlive.com/titles/default/search?q='+encodeURIComponent(gameName)+'&maxItems=5',{
        method:'GET',headers:Object.assign({},hdrs,{'x-xbl-contract-version':'2'})
      }).then(function(r2){
        console.log('Title search response:',r2);
        if(r2.ok&&r2.data){
          var ts=r2.data.titles||r2.data.Titles||r2.data.Results||[];
          if(Array.isArray(ts)&&ts.length>0)titleId=ts[0].titleId||ts[0].TitleId;
        }
        if(titleId){fetchClipsForTitle(titleId)}
        else{console.log('All title lookups failed for',gameName);finishWith([])}
      }).catch(function(){finishWith([])});
    }
  }).catch(function(e){
    console.log('Title history error:',e);
    finishWith([]);
  });
},
closeGamePage:function(){this.st.gpGame=null;this.st.gpClips=null;this.st.gpError=null;this.render()},

// View a searched player's clip in feed
viewPlayerClips:function(clips){
  if(clips.length===0){this.toast('This player has no public clips','err');return}
  this.st.clips=clips.concat(this.st.clips.filter(function(c){return c.id<5000}));
  this.st.page='feed';this.st.filter='all clips';this.render();
},
// === RENDER ===
render:function(){var el=document.getElementById('app');if(this.st.screen==='login')el.innerHTML=this.rL();else if(this.st.screen==='loading')el.innerHTML=this.rLd();else el.innerHTML=this.rM();this.bindAll()},

// Loading screen during auth
rLd:function(){
  return'<div class="loading"><div class="load-logo">GLITCH</div><div class="load-spin"></div><div class="load-msg" id="ls">'+(this.st.loadMsg||'Connecting...')+'</div></div>';
},

// Toast notifications
toast:function(msg,type,dur){
  var old=document.querySelector('.toast');if(old)old.remove();
  var t=document.createElement('div');t.className='toast '+(type||'ok');t.textContent=msg;
  document.body.appendChild(t);setTimeout(function(){t.style.opacity='0';t.style.transition='opacity .3s';setTimeout(function(){t.remove()},300)},dur||3000);
},

// Skeleton loading cards
rSkel:function(){
  var cards='';for(var i=0;i<3;i++){cards+='<div class="skel-card fu d'+(i+1)+'"><div class="skel-th"></div><div style="padding:14px"><div class="skel skel-line w80" style="animation-delay:'+(.1*i)+'s"></div><div class="skel skel-line w60" style="animation-delay:'+(.15*i)+'s"></div><div class="skel skel-line w40" style="animation-delay:'+(.2*i)+'s"></div></div></div>'}
  return'<div style="padding:10px 14px">'+cards+'</div>';
},
rL:function(){
  return'<div class="login"><div class="logo fu">GLITCH</div><div class="login-sub fu d1">AI-Powered Game Clips</div>'
  +'<div class="lcard fu d2"><h2>Welcome to Glitch</h2><p>Sign in with your Xbox account to import your game clips, get AI scores, and share your best plays</p>'
  +'<button id="xb" class="lb lb-x" style="margin-top:6px">\u{1F3AE} Sign in with Xbox</button>'
  +'<div class="ldiv">OR</div><button id="dm" class="lb lb-d">Explore Demo Mode \u2192</button>'
  +'<div id="ls" class="ls"></div></div></div>';
},
rM:function(){var p='';switch(this.st.page){case'feed':return this.rF();case'discover':p=this.rD();break;case'upload':p=this.rU();break;case'friends':p=this.rFr();break;case'profile':p=this.rP();break}return this.rTB()+'<div class="pg">'+p+'</div>'+this.rBN()+(this.st.selClip?this.rMo(this.st.selClip):'')},
rTB:function(){var u=this.st.user,av=u.avUrl?'<img src="'+u.avUrl+'">':u.av,isDemo=u.un==='DemoPlayer';return'<div class="tb"><div class="tb-l">GLITCH</div><div class="tb-r">'+(isDemo?'<button class="ntf">'+this.ic('bell')+'<span class="ntf-d">3</span></button>':'')+'<button class="avsm" data-nav="profile">'+av+'</button></div></div>'},
rBN:function(){var s=this,p=this.st.page,ns=[['feed','home','Feed'],['discover','search','Discover'],['upload','upload','Upload'],['friends','friends','Friends'],['profile','profile','Profile']];return'<div class="bn">'+ns.map(function(n){if(n[0]==='upload')return'<button class="ni" data-nav="'+n[0]+'"><div class="ni-u'+(p===n[0]?' on':'')+'">'+s.ic(n[1])+'</div><span class="ni-l">'+n[2]+'</span></button>';return'<button class="ni'+(p===n[0]?' on':'')+'" data-nav="'+n[0]+'">'+s.ic(n[1])+'<span class="ni-l">'+n[2]+'</span></button>'}).join('')+'</div>'},
rF:function(){var s=this,f=this.st.filter,cl=this.st.clips,isDemo=this.st.user&&this.st.user.un==='DemoPlayer';if(f==='auto-clips')cl=cl.filter(function(c){return c.auto});if(f==='top rated')cl=cl.slice().sort(function(a,b){return b.ai-a.ai});var tabs=isDemo?['trending','friends','auto-clips','top rated']:['all clips','top rated'];
  if(this.st.clipsLoading)return this.rTB()+'<div class="pg"><div class="tabs">'+tabs.map(function(t){return'<button class="tab'+(f===t?' on':'')+'" data-f="'+t+'">'+t[0].toUpperCase()+t.slice(1)+'</button>'}).join('')+'</div>'+this.rSkel()+'</div>'+this.rBN();
  if(cl.length===0)return this.rTB()+'<div class="pg"><div class="tabs">'+tabs.map(function(t){return'<button class="tab'+(f===t?' on':'')+'" data-f="'+t+'">'+t[0].toUpperCase()+t.slice(1)+'</button>'}).join('')+'</div><div class="em"><div class="emi">\u{1F3AE}</div><div class="emt">No clips yet</div><div class="emd">Your Xbox clips will appear here after syncing</div></div></div>'+this.rBN();
  var ptrEl='<div class="ptr'+(this._refreshing?' show':'')+'" id="ptrEl"><div class="ptr-inner">'+(this._refreshing?'<div class="ptr-spin"></div><span class="ptr-txt">Refreshing...</span>':'<span class="ptr-txt">\u2193 Pull to refresh</span>')+'</div></div>';
  return ptrEl+'<div class="feed" id="snapFeed">'+cl.map(function(c,i){return s.rSnapCard(c,i)}).join('')+'</div><div class="feed-tabs" style="position:fixed;top:calc(var(--st));left:50%;transform:translateX(-50%);width:100%;max-width:480px;z-index:101;padding:10px 14px;display:flex;gap:6px">'+tabs.map(function(t){return'<button class="tab" style="background:#0008;border-color:#fff3;color:#fffc;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);'+(f===t?'background:var(--a);border-color:var(--a);color:var(--bg)':'')+'" data-f="'+t+'">'+t[0].toUpperCase()+t.slice(1)+'</button>'}).join('')+'</div><div class="feed-bnav" style="position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;z-index:101">'+this.rBN2()+'</div>'+(this.st.selClip?this.rMo(this.st.selClip):'')},

rSnapCard:function(c,i){var s=this,lk=this.st.liked.has(c.id),u=this.st.user,av=u.avUrl?'<img src="'+u.avUrl+'">':u.av;
  var vidEl=c.vidUrl?'<video class="snap-vid" data-idx="'+i+'" src="'+c.vidUrl+'" poster="'+(c.thUrl||'')+'" playsinline muted loop preload="'+(i<2?'auto':'none')+'"></video>':'';
  var bg=c.thUrl?'background-image:url('+c.thUrl+');background-size:cover;background-position:center':'background:'+(c.vidUrl?'#000':this.tg(c.sd));
  return'<div class="snap-item" data-idx="'+i+'" style="'+bg+'">'+vidEl
  +'<div class="snap-overlay">'
  // Top info
  +'<div class="snap-top"><div class="snap-user"><div class="cav" style="width:32px;height:32px;font-size:16px;border-color:#fff3">'+(c.user.avUrl?'<img src="'+c.user.avUrl+'">':c.user.av)+'</div><span style="font-size:14px;font-weight:700;text-shadow:0 1px 4px #0008">'+c.user.un+'</span><span style="font-size:12px;color:#fff9;text-shadow:0 1px 4px #0008">'+c.ago+'</span></div></div>'
  // Bottom info
  +'<div class="snap-bot"><div class="snap-title">'+c.title+'</div><div style="display:flex;align-items:center;gap:8px;margin-top:4px"><span class="cgm" style="background:#fff2;color:#fffc">'+c.game+'</span>'+this.aib(c.ai)+'</div></div>'
  +'</div>'
  // Tap to pause/play indicator
  +'<div class="snap-pause" data-idx="'+i+'"></div>'
  // Right actions (after pause layer so clicks work)
  +'<div class="snap-acts">'
  +'<button class="snap-act snap-vol-btn" data-a="vol">'+(s._snapMuted!==false?'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>':'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>')+'<span>Vol</span></button>'
  +'<button class="snap-act" data-a="lk" data-id="'+c.id+'">'+(lk?this.ic('heartF'):this.ic('heart'))+'<span>'+(c.lk+(lk?1:0))+'</span></button>'
  +'<button class="snap-act" data-a="oc" data-id="'+c.id+'">'+this.ic('cmt')+'<span>'+(c.cm+(s.st.comments[c.id]||[]).length)+'</span></button>'
  +'<button class="snap-act" data-a="sh" data-id="'+c.id+'">'+this.ic('share')+'<span>Share</span></button>'
  +'</div>'
  +'</div>'},

// Alternate bottom nav for feed (transparent)
rBN2:function(){var s=this,p=this.st.page,ns=[['feed','home','Feed'],['discover','search','Discover'],['upload','upload','Upload'],['friends','friends','Friends'],['profile','profile','Profile']];return'<div style="display:flex;align-items:flex-start;justify-content:space-around;padding:6px 0;padding-bottom:calc(8px + var(--sb));background:#0008;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px)">'+ns.map(function(n){if(n[0]==='upload')return'<button class="ni" data-nav="'+n[0]+'" style="color:#fffc"><div class="ni-u'+(p===n[0]?' on':'')+'">'+s.ic(n[1])+'</div><span class="ni-l">'+n[2]+'</span></button>';return'<button class="ni'+(p===n[0]?' on':'')+'" data-nav="'+n[0]+'" style="'+(p===n[0]?'':'color:#fff9')+'">'+s.ic(n[1])+'<span class="ni-l">'+n[2]+'</span></button>'}).join('')+'</div>'},
rC:function(c,i){var lk=this.st.liked.has(c.id),bg=c.thUrl?'background-image:url('+c.thUrl+')':'background:'+this.tg(c.sd);var thContent=c.vidUrl?'<video class="feed-vid" data-clipid="'+c.id+'" src="'+c.vidUrl+'" poster="'+(c.thUrl||'')+'" playsinline muted loop preload="none" style="width:100%;height:100%;object-fit:cover;position:absolute;inset:0"></video>':'';return'<div class="clip fu d'+(Math.min(i+1,5))+'"><div class="cth" style="'+bg+'" data-a="oc" data-id="'+c.id+'">'+thContent+'<div class="cpl feed-play" data-clipid="'+c.id+'">'+this.ic('play',32)+'</div><span class="cdur">'+c.dur+'</span>'+(c.auto?'<span class="cac">'+this.ic('zap',12)+' AUTO</span>':'')+'<span class="cvw">'+this.ic('eye',12)+' '+c.vw.toLocaleString()+'</span></div><div class="cbd"><div class="chd"><div style="flex:1;min-width:0"><div class="cur"><div class="cav">'+(c.user.avUrl?'<img src="'+c.user.avUrl+'">':c.user.av)+'</div><span class="cun">'+c.user.un+'</span><span class="ctm">'+c.ago+'</span></div><div class="ctt">'+c.title+'</div><span class="cgm">'+c.game+'</span></div>'+this.aib(c.ai)+'</div><div class="cas"><button class="ca'+(lk?' lk':'')+'" data-a="lk" data-id="'+c.id+'">'+(lk?this.ic('heartF'):this.ic('heart'))+' '+(c.lk+(lk?1:0))+'</button><button class="ca" data-a="oc" data-id="'+c.id+'">'+this.ic('cmt')+' '+(c.cm+(this.st.comments[c.id]||[]).length)+'</button><button class="ca" data-a="sh" data-id="'+c.id+'">'+this.ic('share')+' Share</button></div></div></div>'},
rMo:function(c){var lk=this.st.liked.has(c.id),isDemo=this.st.user&&this.st.user.un==='DemoPlayer',cm=[].concat(this.st.comments[c.id]||[],isDemo?this.DCMTS:[]),bg=c.thUrl?'background-image:url('+c.thUrl+');background-size:cover;background-position:center':'background:'+this.tg(c.sd);var muteIc='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>',mutedIc='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>';
var vidHtml=c.vidUrl?'<video id="clipVid" style="width:100%;aspect-ratio:16/9;background:#000;object-fit:contain" poster="'+(c.thUrl||'')+'" playsinline controls><source src="'+c.vidUrl+'" type="video/mp4"></video>':'<div class="cth" style="'+bg+'"><div class="cpl" data-a="noVid">'+this.ic('play',32)+'</div></div>';var muteBtn=c.vidUrl?'<button class="mute-btn" data-a="mute" title="Toggle mute">'+mutedIc+'</button>':'';return'<div class="mo" data-a="cbg"><div class="mc" onclick="event.stopPropagation()"><div style="position:relative">'+vidHtml+muteBtn+'<button class="mx" data-a="cm">'+this.ic('x')+'</button></div><div style="padding:16px"><div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px"><div style="flex:1"><div class="ctt" style="font-size:18px">'+c.title+'</div><div style="display:flex;align-items:center;gap:8px;margin-top:6px"><div class="cav">'+(c.user.avUrl?'<img src="'+c.user.avUrl+'">':c.user.av)+'</div><span class="cun">'+c.user.un+'</span><span class="ctm">'+c.ago+'</span></div></div>'+this.aib(c.ai)+'</div><div class="cas" style="margin-top:16px;padding-top:14px"><button class="ca'+(lk?' lk':'')+'" data-a="lk" data-id="'+c.id+'">'+(lk?this.ic('heartF'):this.ic('heart'))+' '+(c.lk+(lk?1:0))+'</button><button class="ca">'+this.ic('cmt')+' '+(c.cm+(this.st.comments[c.id]||[]).length)+'</button><button class="ca" data-a="sh" data-id="'+c.id+'">'+this.ic('share')+' Share</button></div></div><div class="cs"><div style="font-size:15px;font-weight:700;margin-bottom:10px">Comments</div>'+(cm.length===0?'<div style="text-align:center;padding:20px 0;color:var(--d);font-size:13px">No comments yet \u2014 be the first!</div>':cm.map(function(m){return'<div class="cmi"><div class="cmav">'+m.u.av+'</div><div><div class="cmn">'+m.u.n+'</div><div class="cmt2">'+m.t+'</div><div class="cmtm">'+m.tm+'</div></div></div>'}).join(''))+'<div class="cr"><input class="ci2" id="ci" placeholder="Add a comment..." value="'+this.st.newCmt+'"><button class="csb" data-a="sc">Post</button></div></div></div></div>'},
rGP:function(){
  var s=this,g=this.st.gpGame,cl=this.st.gpClips,ld=this.st.gpLoading,err=this.st.gpError;
  var content='';
  if(ld){content='<div style="text-align:center;padding:40px 0"><div class="load-spin" style="margin:0 auto 12px"></div><div style="color:var(--d);font-size:13px">Loading '+g+' clips...</div></div>'}
  else if(cl&&cl.length>0){
    // Separate user's own clips (id < 8000) from community clips (id >= 8000)
    var own=cl.filter(function(c){return c.id<8000}),comm=cl.filter(function(c){return c.id>=8000});
    var ownSec='',commSec='';
    if(own.length>0){ownSec='<div class="stt" style="margin-top:4px">\u{1F3AE} YOUR CLIPS</div>'+own.map(function(c){var idx=cl.indexOf(c);var bg=c.thUrl?'background-image:url('+c.thUrl+')':'background:'+s.tg(c.sd);return'<div class="cli" data-a="gpoc" data-idx="'+idx+'"><div class="clt" style="'+bg+'"><span style="position:absolute;bottom:4px;right:4px;font-size:10px;color:#fff;background:#000a;border-radius:4px;padding:1px 5px">'+c.dur+'</span></div><div class="clif"><div class="cltt">'+c.title+'</div><div class="clm">'+c.user.un+' \u00b7 '+c.ago+'</div><div style="margin-top:6px">'+s.aib(c.ai)+'</div></div></div>'}).join('')}
    if(comm.length>0){commSec='<div class="stt" style="margin-top:12px">\u{1F30D} COMMUNITY CLIPS</div>'+comm.map(function(c){var idx=cl.indexOf(c);var bg=c.thUrl?'background-image:url('+c.thUrl+')':'background:'+s.tg(c.sd);return'<div class="cli" data-a="gpoc" data-idx="'+idx+'"><div class="clt" style="'+bg+'"><span style="position:absolute;bottom:4px;right:4px;font-size:10px;color:#fff;background:#000a;border-radius:4px;padding:1px 5px">'+c.dur+'</span></div><div class="clif"><div class="cltt">'+c.title+'</div><div class="clm">'+c.user.un+' \u00b7 '+c.ago+'</div><div style="margin-top:6px">'+s.aib(c.ai)+'</div></div></div>'}).join('')}
    content=ownSec+commSec;
  }
  else if(err){content='<div class="em" style="margin-top:10px"><div class="emi">\u{1F3AE}</div><div class="emt">No Clips Found</div><div class="emd">'+err+'</div></div>'}
  else{content='<div class="em" style="margin-top:10px"><div class="emi">\u{1F3AE}</div><div class="emt">No Clips</div><div class="emd">No public clips found for '+g+'</div></div>'}
  return'<div style="display:flex;align-items:center;gap:12px;padding:16px 16px 4px"><button style="padding:6px 14px;border-radius:10px;background:var(--sf);color:var(--t);font-size:13px;font-weight:700;border:1px solid #ffffff11;cursor:pointer" data-a="gpback">\u{2190} Back</button><div class="pt" style="padding:0;margin:0">'+g+'</div></div>'+content},
rD:function(){if(this.st.gpGame)return this.rGP();var s=this,isDemo=this.st.user&&this.st.user.un==='DemoPlayer',dsl=this.st.dsLoading,dsr=this.st.dsResults,dse=this.st.dsError,dsq=this.st.dsQuery||'';
  if(isDemo)return'<div class="pt">Discover</div><div class="sb">'+this.ic('search')+'<input placeholder="Search clips, games, players..."></div><div class="stt">\u{1F525} TRENDING GAMES</div><div class="gt">'+this.GAMES.map(function(g){return'<button class="gti" data-a="gp" data-g="'+g+'">'+g+'</button>'}).join('')+'</div><div class="stt">\u{26A1} TOP CLIPPERS</div>'+this.USERS.slice(0,5).map(function(u,i){return'<div class="lr"><span class="lrk">#'+(i+1)+'</span><div class="lra">'+u.av+'</div><div style="flex:1"><div style="font-size:14px;font-weight:700">'+u.un+'</div><div style="font-size:11px;color:var(--d)">'+u.cl+' clips \u00b7 '+u.frs.toLocaleString()+' followers</div></div>'+s.aib(~~(Math.random()*15)+85)+'</div>'}).join('');
  // Real user — gamertag search
  var results='';
  if(dsl){results='<div style="text-align:center;padding:40px 0"><div class="load-spin" style="margin:0 auto 12px"></div><div style="color:var(--d);font-size:13px">Searching for "'+dsq+'"...</div></div>'}
  else if(dse){results='<div class="em" style="margin-top:10px"><div class="emi">\u{1F615}</div><div class="emt">Not Found</div><div class="emd">'+dse+'</div></div>'}
  else if(dsr){
    var u=dsr.user,cl=dsr.clips;
    results='<div class="uc fu" style="margin-top:6px"><div class="uav" style="border-color:#ff6b2b33">'+(u.avUrl?'<img src="'+u.avUrl+'" style="width:100%;height:100%;object-fit:cover">':u.av)+'</div><div class="ui"><div class="unr"><span class="un">'+u.un+'</span><span class="xb">XBOX</span></div><div class="ut">\u{1F3C6} '+u.gs+' Gamerscore</div><div class="us">'+cl.length+' public clips</div></div>'+(cl.length>0?'<button class="fb nf" data-a="vpc">View Clips</button>':'')+'</div>'
    +(cl.length>0?'<div class="stt" style="margin-top:16px">\u{1F3AC} PUBLIC CLIPS</div>'+cl.slice(0,6).map(function(c){var bg=c.thUrl?'background-image:url('+c.thUrl+')':'background:'+s.tg(c.sd);return'<div class="cli" data-a="oc2" data-idx="'+cl.indexOf(c)+'"><div class="clt" style="'+bg+'"><span style="position:absolute;bottom:4px;right:4px;font-size:10px;color:#fff;background:#000a;border-radius:4px;padding:1px 5px">'+c.dur+'</span></div><div class="clif"><div class="cltt">'+c.title+'</div><div class="clm">'+c.game+' \u00b7 '+c.ago+'</div><div style="margin-top:6px">'+s.aib(c.ai)+'</div></div></div>'}).join(''):'<div style="padding:16px;text-align:center;color:var(--d);font-size:13px">This player has no public clips</div>');
  } else {
    results='';
  }
  // Trending games & top clippers for all users
  var trendSec='<div class="stt">\u{1F525} TRENDING GAMES</div><div class="gt">'+this.GAMES.map(function(g){return'<button class="gti" data-a="gp" data-g="'+g+'">'+g+'</button>'}).join('')+'</div>';
  return'<div class="pt">Discover</div><div style="display:flex;gap:8px;padding:0 16px 14px"><div class="sb" style="flex:1;margin:0">'+this.ic('search')+'<input id="dsInput" placeholder="Enter Xbox Gamertag..." value="'+dsq+'"></div><button id="dsBtn" class="bsy" style="width:auto;padding:10px 18px;border-radius:14px">\u{1F50E}</button></div>'+results+trendSec},
rU:function(){var um=this.st.upMode,sp=this.st.syncProg,ai=this.st.aiSet,ls=["Detect multi-kills","Detect clutch rounds","Detect high-action","Detect trick shots","Auto-post 85+ clips"];return'<div class="pt">Upload</div><div class="mt"><button class="mb'+(um==='auto'?' on':'')+'" data-m="auto">\u{1F916} Auto</button><button class="mb'+(um==='manual'?' on':'')+'" data-m="manual">\u{1F4E4} Manual</button></div>'+(um==='auto'?'<div class="syc"><div class="syh"><div class="syi">\u{1F3AE}</div><div><div class="syt">Xbox Game DVR</div><div class="syd">Import captures from Xbox</div></div></div>'+(sp>=0?'<div class="pbr"><div class="pfl" style="width:'+Math.min(sp,100)+'%"></div></div><div style="font-size:12px;color:var(--d)">'+(sp>=100?'\u2705 Synced 8 clips!':'Syncing... '+~~(Math.min(sp,99))+'%')+'</div>':'<button class="bsy" data-a="sy">Sync Now</button>')+'</div><div class="aic"><div class="ait">\u{26A1} AI Settings</div>'+ls.map(function(l,i){return'<div class="air"><span class="ail">'+l+'</span><button class="tg '+(ai[i]?'on':'off')+'" data-a="ta" data-i="'+i+'"><div class="tgk"></div></button></div>'}).join('')+'</div>':'<div style="background:var(--c);border-radius:18px;padding:44px 24px;margin:0 16px;border:2px dashed #ffffff15;text-align:center"><div style="font-size:48px;margin-bottom:12px">\u{1F4E4}</div><div style="font-size:16px;font-weight:700">Upload a clip</div><div style="font-size:13px;color:var(--d);margin-top:4px;margin-bottom:20px">Choose from your captures</div><button class="bsy" style="width:auto;padding:10px 28px;display:inline-block">Choose File</button></div>')},
rFr:function(){var s=this,isDemo=this.st.user&&this.st.user.un==='DemoPlayer';if(!isDemo){var frq=this.st.frQuery||'',frl=this.st.frLoading,frr=this.st.frResult,fre=this.st.frError;
  var frContent='';
  if(frl){frContent='<div style="text-align:center;padding:30px 0"><div class="load-spin" style="margin:0 auto 12px"></div><div style="color:var(--d);font-size:13px">Searching...</div></div>'}
  else if(fre){frContent='<div class="em" style="margin-top:10px"><div class="emi">\u{1F615}</div><div class="emt">Not Found</div><div class="emd">'+fre+'</div></div>'}
  else if(frr){var u=frr.user;frContent='<div class="uc fu" style="margin-top:6px"><div class="uav" style="border-color:#ff6b2b33">'+(u.avUrl?'<img src="'+u.avUrl+'" style="width:100%;height:100%;object-fit:cover">':u.av)+'</div><div class="ui"><div class="unr"><span class="un">'+u.un+'</span><span class="xb">XBOX</span></div><div class="ut">\u{1F3C6} '+u.gs+' Gamerscore</div><div class="us">'+frr.clips.length+' public clips</div></div>'+(frr.clips.length>0?'<button class="fb nf" data-a="frvpc">View Clips</button>':'')+'</div>'}
  else{
    if(s.st.sugFriends===null&&!s.st.sugFrLoading){setTimeout(function(){s.loadSuggestedFriends()},0)}
    var sugSec='';
    if(s.st.sugFrLoading){sugSec='<div style="text-align:center;padding:20px 0"><div class="load-spin" style="margin:0 auto 12px"></div><div style="color:var(--d);font-size:13px">Loading friends list...</div></div>'}
    else if(s.st.sugFriends&&s.st.sugFriends.length>0){
      var favFriends=s.st.sugFriends.filter(function(f){return f.isFav});
      var otherFriends=s.st.sugFriends.filter(function(f){return!f.isFav});
      var favSec='',otherSec='';
      if(favFriends.length>0){favSec='<div class="stt">\u{2B50} FAVORITES</div>'+favFriends.map(function(f){return'<div class="uc fu"><div class="uav" style="border-color:#a855f744">'+(f.avUrl?'<img src="'+f.avUrl+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%">':'\u{1F3AE}')+'</div><div class="ui"><div class="unr"><span class="un">'+f.un+'</span><span style="font-size:10px;padding:1px 6px;border-radius:6px;background:#a855f722;color:#a855f7;font-weight:700;margin-left:4px">\u{2B50} FAV</span></div><div class="ut">\u{1F3C6} '+f.gs+' Gamerscore</div></div></div>'}).join('')}
      if(otherFriends.length>0){otherSec='<div class="stt" style="margin-top:8px">\u{1F465} ALL FRIENDS</div>'+otherFriends.slice(0,20).map(function(f){return'<div class="uc fu"><div class="uav" style="border-color:#ff6b2b33">'+(f.avUrl?'<img src="'+f.avUrl+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%">':'\u{1F3AE}')+'</div><div class="ui"><div class="unr"><span class="un">'+f.un+'</span><span class="xb">XBOX</span></div><div class="ut">\u{1F3C6} '+f.gs+' Gamerscore</div></div></div>'}).join('')+(otherFriends.length>20?'<div style="text-align:center;padding:8px;color:var(--d);font-size:12px">+ '+(otherFriends.length-20)+' more friends</div>':'')}
      sugSec=favSec+otherSec;
    }
    frContent=sugSec+'<div class="em" style="margin-top:10px"><div class="emi">\u{1F465}</div><div class="emt">Find Xbox Friends</div><div class="emd">Search for any Xbox gamertag to view their profile and clips, or invite friends to join Glitch!</div><button class="bsy" style="width:auto;padding:12px 28px;display:inline-block;margin-top:16px" data-a="invite">\u{1F4E8} Invite Friends</button><button class="bsy" style="width:auto;padding:12px 28px;display:inline-block;margin-top:8px;background:var(--sf);color:var(--t);border:1px solid #ffffff11" data-nav="discover">\u{1F50D} Go to Discover</button></div>';
  }
  return'<div class="pt">Friends</div><div style="display:flex;gap:8px;padding:0 16px 14px"><div class="sb" style="flex:1;margin:0">'+this.ic('search')+'<input id="frInput" placeholder="Search Xbox gamertag..." value="'+frq+'"></div><button id="frBtn" class="bsy" style="width:auto;padding:10px 18px;border-radius:14px">\u{1F50E}</button></div>'+frContent;}var ft=this.st.fTab,fs=this.st.fSearch,fl=this.st.following,us=this.USERS.filter(function(u){return u.un.toLowerCase().indexOf(fs.toLowerCase())!==-1});if(ft==='friends')us=us.filter(function(u){return fl.has(u.id)});return'<div class="pt">Friends</div><div class="sb">'+this.ic('search')+'<input placeholder="Search gamertags..." id="fs" value="'+fs+'"></div><div class="tabs" style="padding-top:0">'+['friends','discover','requests'].map(function(t){return'<button class="tab'+(ft===t?' on':'')+'" data-ft="'+t+'">'+(t==='friends'?'Following':t[0].toUpperCase()+t.slice(1))+'</button>'}).join('')+'</div>'+(us.length===0?'<div class="em"><div class="emi">\u{1F465}</div><div class="emt">No results</div></div>':us.map(function(u){var f=fl.has(u.id);return'<div class="uc fu"><div class="uav'+(f?' fl':'')+'">'+u.av+'</div><div class="ui"><div class="unr"><span class="un">'+u.un+'</span><span class="xb">XBOX</span></div><div class="ut">'+u.gt+'</div><div class="us">'+u.cl+' clips \u00b7 '+u.frs.toLocaleString()+' followers</div></div><button class="fb'+(f?' fl':' nf')+'" data-a="fw" data-id="'+u.id+'">'+(f?s.ic('chk',14)+' Following':'Follow')+'</button></div>'}).join(''))},
rP:function(){var u=this.st.user,pt=this.st.pTab,s=this,cl=this.st.clips.filter(function(c){return c.user.id===u.id}),av=u.avUrl?'<img src="'+u.avUrl+'">':u.av;return'<div class="ph"><div class="pav">'+av+'</div><div class="pnm">'+u.un+'</div><div class="ptg"><span class="xb">XBOX</span> '+u.gt+(u.gs?' \u00b7 \u{1F3C6} '+u.gs:'')+'</div><div class="pss"><div style="text-align:center"><div class="pv">'+u.cl+'</div><div class="pl">Clips</div></div><div style="text-align:center"><div class="pv">'+u.frs.toLocaleString()+'</div><div class="pl">Followers</div></div><div style="text-align:center"><div class="pv">'+u.fg+'</div><div class="pl">Following</div></div></div><div style="display:flex;gap:8px;justify-content:center;margin-top:16px"><button style="padding:8px 20px;border-radius:10px;background:var(--a);color:var(--bg);font-size:13px;font-weight:700" data-a="invite">\u{1F4E8} Invite Friends</button><button style="padding:8px 16px;border-radius:10px;background:var(--sf);color:var(--r);border:1px solid #ffffff11;font-size:13px;font-weight:700" data-a="lo">'+this.ic('out',14)+' Logout</button></div></div><div class="ptabs">'+['clips','highlights','stats'].map(function(t){return'<button class="ptb'+(pt===t?' on':'')+'" data-pt="'+t+'">'+t.toUpperCase()+'</button>'}).join('')+'</div>'+(pt==='clips'?(cl.length>0?cl.map(function(c){var bg=c.thUrl?'background-image:url('+c.thUrl+')':'background:'+s.tg(c.sd);return'<div class="cli" data-a="oc" data-id="'+c.id+'"><div class="clt" style="'+bg+'"><span style="position:absolute;bottom:4px;right:4px;font-size:10px;color:#fff;background:#000a;border-radius:4px;padding:1px 5px">'+c.dur+'</span></div><div class="clif"><div class="cltt">'+c.title+'</div><div class="clm">'+c.game+' \u00b7 '+c.vw.toLocaleString()+' views</div><div style="margin-top:6px">'+s.aib(c.ai)+'</div></div></div>'}).join(''):'<div class="em"><div class="emi">\u{1F3AE}</div><div class="emt">No clips yet</div><div class="emd">Sync your Xbox captures</div></div>'):pt==='stats'?'<div class="sg">'+[{i:'\u{1F441}',v:cl.reduce(function(a,c){return a+c.vw},0).toLocaleString(),l:'Views'},{i:'\u{2764}',v:cl.reduce(function(a,c){return a+c.lk},0).toString(),l:'Likes'},{i:'\u{26A1}',v:cl.length>0?(cl.reduce(function(a,c){return a+c.ai},0)/cl.length).toFixed(1):'--',l:'Avg AI'},{i:'\u{1F3C6}',v:cl.length>0?Math.max.apply(null,cl.map(function(c){return c.ai})).toString():'--',l:'Best'},{i:'\u{1F3AE}',v:u.cl.toString(),l:'Clips'},{i:'\u{1F3AF}',v:u.gs||'--',l:'Gamerscore'}].map(function(x){return'<div class="sc"><div class="sci">'+x.i+'</div><div class="scv">'+x.v+'</div><div class="scl">'+x.l+'</div></div>'}).join('')+'</div>':'<div class="em"><div class="emi">\u{1F916}</div><div class="emt">AI Highlights Reel</div><div class="emd">Processing your gameplay...</div><div style="margin:20px auto 0;max-width:260px"><div class="pbr"><div class="pfl" style="width:67%"></div></div></div></div>')},
// === EVENTS ===
bindAll:function(){
  var s=this;
  document.querySelectorAll('[data-nav]').forEach(function(b){b.onclick=function(){s.st.page=b.dataset.nav;s.render()}});
  var xb=document.getElementById('xb');if(xb)xb.onclick=function(){s.startLogin()};
  var dm=document.getElementById('dm');if(dm)dm.onclick=function(){s.loginDemo()};
  document.querySelectorAll('[data-f]').forEach(function(b){b.onclick=function(){s.st.filter=b.dataset.f;s.render()}});
  document.querySelectorAll('[data-a="lk"]').forEach(function(b){b.onclick=function(e){e.stopPropagation();s.toggleLike(parseInt(b.dataset.id))}});
  document.querySelectorAll('[data-a="oc"]').forEach(function(b){b.onclick=function(){var c=s.st.clips.find(function(x){return x.id===parseInt(b.dataset.id)});if(c){s.st.selClip=c;s.render()}}});
  var cm=document.querySelector('[data-a="cm"]');if(cm)cm.onclick=function(){s.st.selClip=null;s.render()};
  var cbg=document.querySelector('[data-a="cbg"]');if(cbg)cbg.onclick=function(e){if(e.target===e.currentTarget){s.st.selClip=null;s.render()}};
  var sc=document.querySelector('[data-a="sc"]');if(sc)sc.onclick=function(){s.addCmt()};
  var cin=document.getElementById('ci');if(cin){cin.addEventListener('input',function(e){s.st.newCmt=e.target.value});cin.addEventListener('keydown',function(e){if(e.key==='Enter')s.addCmt()})}
  // Mute/unmute toggle in modal
  var muteBtn=document.querySelector('[data-a="mute"]');
  if(muteBtn){var vid=document.getElementById('clipVid');if(vid){
    vid.muted=true;
    muteBtn.onclick=function(){
      vid.muted=!vid.muted;
      muteBtn.innerHTML=vid.muted?'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>':'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>';
    };
  }}
  document.querySelectorAll('[data-a="fw"]').forEach(function(b){b.onclick=function(){s.toggleFollow(parseInt(b.dataset.id))}});
  document.querySelectorAll('[data-ft]').forEach(function(b){b.onclick=function(){s.st.fTab=b.dataset.ft;s.render()}});
  var fs=document.getElementById('fs');if(fs)fs.addEventListener('input',function(e){s.st.fSearch=e.target.value;s.render();setTimeout(function(){var el=document.getElementById('fs');if(el){el.focus();el.selectionStart=el.selectionEnd=el.value.length}},0)});
  document.querySelectorAll('[data-pt]').forEach(function(b){b.onclick=function(){s.st.pTab=b.dataset.pt;s.render()}});
  document.querySelectorAll('[data-m]').forEach(function(b){b.onclick=function(){s.st.upMode=b.dataset.m;s.render()}});
  var sy=document.querySelector('[data-a="sy"]');if(sy)sy.onclick=function(){s.startSync()};
  document.querySelectorAll('[data-a="ta"]').forEach(function(b){b.onclick=function(){s.toggleAI(parseInt(b.dataset.i))}});
  document.querySelectorAll('[data-a="sh"]').forEach(function(b){b.onclick=function(e){e.stopPropagation();var c=s.st.clips.find(function(x){return x.id===parseInt(b.dataset.id)});if(c)s.shareClip(c)}});
  document.querySelectorAll('[data-a="invite"]').forEach(function(b){b.onclick=function(){s.shareApp()}});
  var lo=document.querySelector('[data-a="lo"]');if(lo)lo.onclick=function(){s.logout()};
  var vpc=document.querySelector('[data-a="vpc"]');if(vpc)vpc.onclick=function(){if(s.st.dsResults)s.viewPlayerClips(s.st.dsResults.clips)};
  document.querySelectorAll('[data-a="oc2"]').forEach(function(b){b.onclick=function(){if(s.st.dsResults){var c=s.st.dsResults.clips[parseInt(b.dataset.idx)];if(c){s.st.selClip=c;s.render()}}}});

  // Snap scroll: play only the visible video
  var feed=document.getElementById('snapFeed');
  if(feed){
    var playIdx=function(){
      var items=feed.querySelectorAll('.snap-item');
      var best=-1,bestR=0;
      items.forEach(function(it,i){
        var r=it.getBoundingClientRect(),vh=window.innerHeight;
        var vis=Math.max(0,Math.min(r.bottom,vh)-Math.max(r.top,0))/vh;
        if(vis>bestR){bestR=vis;best=i}
      });
      // Pause all, play best
      feed.querySelectorAll('.snap-vid').forEach(function(v){v.pause();v.classList.remove('playing')});
      if(best>=0){
        var vid=items[best].querySelector('.snap-vid');
        if(vid&&!s._paused){vid.play().then(function(){vid.classList.add('playing')}).catch(function(){})}
        s._curIdx=best;
        // Preload adjacent videos
        [best-1,best+1,best+2].forEach(function(pi){
          if(pi>=0&&pi<items.length&&pi!==best){
            var pv=items[pi].querySelector('.snap-vid');
            if(pv&&pv.preload==='none')pv.preload='metadata';
          }
        });
      }
    };
    feed.addEventListener('scroll',function(){clearTimeout(s._scrollT);s._scrollT=setTimeout(playIdx,150)});
    s._paused=false;
    setTimeout(playIdx,300);

    // Pull to refresh
    var ptrStartY=0,ptrActive=false;
    feed.addEventListener('touchstart',function(e){
      if(feed.scrollTop<=0){ptrStartY=e.touches[0].clientY;ptrActive=true}else{ptrActive=false}
    },{passive:true});
    feed.addEventListener('touchmove',function(e){
      if(!ptrActive||s._refreshing)return;
      var dy=e.touches[0].clientY-ptrStartY,el=document.getElementById('ptrEl');
      if(dy>60&&el){el.classList.add('show');el.querySelector('.ptr-txt').textContent='\u2191 Release to refresh'}
      else if(el){el.classList.remove('show')}
    },{passive:true});
    feed.addEventListener('touchend',function(){
      if(!ptrActive||s._refreshing)return;
      var el=document.getElementById('ptrEl');
      if(el&&el.classList.contains('show')){s.refreshFeed()}
      else if(el){el.classList.remove('show')}
      ptrActive=false;
    });
  }

  // Tap to pause/play + double-tap to like
  document.querySelectorAll('.snap-pause').forEach(function(b){
    b._tapCount=0;
    b.onclick=function(e){
      e.stopPropagation();
      var idx=parseInt(b.dataset.idx),vid=b.parentElement.querySelector('.snap-vid');
      b._tapCount++;
      if(b._tapCount===1){
        b._tapTimer=setTimeout(function(){
          b._tapCount=0;
          // Single tap: pause/play
          if(!vid)return;
          if(vid.paused){s._paused=false;vid.play().catch(function(){});b.innerHTML=''}
          else{s._paused=true;vid.pause();b.innerHTML='<div class="snap-pause-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="white"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg></div>'}
        },280);
      } else if(b._tapCount===2){
        clearTimeout(b._tapTimer);b._tapCount=0;
        // Double tap: like + heart animation
        var clip=s.st.clips[idx];
        if(clip){
          if(!s.st.liked.has(clip.id))s.toggleLike(clip.id);
          // Show heart animation
          var heart=document.createElement('div');heart.className='dt-heart';
          heart.innerHTML='<svg width="80" height="80" viewBox="0 0 24 24" fill="#ff4757" stroke="#ff4757" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>';
          b.parentElement.appendChild(heart);
          setTimeout(function(){heart.remove()},950);
        }
      }
    };
  });

  // Volume/mute toggle — per-card button above like
  if(s._snapMuted===undefined)s._snapMuted=true;
  var snapVolBtns=document.querySelectorAll('.snap-vol-btn');
  if(snapVolBtns.length){
    var mutedIcS='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg><span>Vol</span>';
    var unmutedIcS='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg><span>Vol</span>';
    snapVolBtns.forEach(function(b){
      b.innerHTML=s._snapMuted?mutedIcS:unmutedIcS;
      b.onclick=function(e){
        e.stopPropagation();
        s._snapMuted=!s._snapMuted;
        snapVolBtns.forEach(function(btn){btn.innerHTML=s._snapMuted?mutedIcS:unmutedIcS});
        document.querySelectorAll('.snap-vid').forEach(function(v){v.muted=s._snapMuted});
      };
    });
  }

  // Gamertag search
  var dsInput=document.getElementById('dsInput'),dsBtn=document.getElementById('dsBtn');
  if(dsBtn&&dsInput){
    var doSearch=function(){var q=dsInput.value.trim();if(q.length>0)s.searchGamertag(q)};
    dsBtn.onclick=doSearch;
    dsInput.addEventListener('keydown',function(e){if(e.key==='Enter')doSearch()});
  }

  // Friends page search
  var frInput=document.getElementById('frInput'),frBtn=document.getElementById('frBtn');
  if(frBtn&&frInput){
    var doFrSearch=function(){var q=frInput.value.trim();if(q.length>0)s.searchFriend(q)};
    frBtn.onclick=doFrSearch;
    frInput.addEventListener('keydown',function(e){if(e.key==='Enter')doFrSearch()});
  }
  var frvpc=document.querySelector('[data-a="frvpc"]');
  if(frvpc)frvpc.onclick=function(){if(s.st.frResult)s.viewPlayerClips(s.st.frResult.clips)};

  // Game page: tag clicks, back button, clip opens
  document.querySelectorAll('[data-a="gp"]').forEach(function(b){b.onclick=function(){s.openGamePage(b.dataset.g)}});
  var gpb=document.querySelector('[data-a="gpback"]');if(gpb)gpb.onclick=function(){s.closeGamePage()};
  document.querySelectorAll('[data-a="gpoc"]').forEach(function(b){b.onclick=function(){if(s.st.gpClips){var c=s.st.gpClips[parseInt(b.dataset.idx)];if(c){s.st.selClip=c;s.render()}}}});
}
};

// === BOOT ===
document.addEventListener('DOMContentLoaded',function(){
  // Check URL hash for implicit flow token
  var hash=location.hash;
  if(hash&&hash.indexOf('access_token')!==-1){
    var params=new URLSearchParams(hash.substring(1));
    var token=params.get('access_token');
    history.replaceState(null,'',location.pathname);
    if(token){
      console.log('Got access_token from implicit flow');
      G.render(); // Show login screen with status
      G.handleAuth(token);
      return;
    }
  }
  // Check for error in hash
  if(hash&&hash.indexOf('error')!==-1){
    var ep=new URLSearchParams(hash.substring(1));
    history.replaceState(null,'',location.pathname);
    G.render();
    G.setSt('Error: '+(ep.get('error_description')||ep.get('error')),'err');
    return;
  }
  // Restore persisted likes/follows
  G.restoreSocial();
  // Check saved session
  var sess=G.ld('glitch_sess');
  if(sess&&sess.user){
    G.st.user=sess.user;G.st.screen='main';
    var isDemo=sess.user.un==='DemoPlayer';
    if(isDemo){
      G.genClips();G.render();
    } else {
      // Real Xbox user: restore cached clips immediately, then refresh from API
      var cached=G.ld('glitch_clips');
      if(cached&&cached.length>0){
        // Reattach user ref (JSON parse loses it)
        cached.forEach(function(c){if(!c.user||!c.user.un)c.user=sess.user});
        G.st.clips=cached;G.st.user.cl=cached.length;G.render();
        // Background refresh from Xbox API
        var auth=G.ld('glitch_xauth');
        if(auth){
          G.px('https://gameclipsmetadata.xboxlive.com/users/me/clips',{method:'GET',headers:{'Authorization':'XBL3.0 x='+auth.uh+';'+auth.xt,'x-xbl-contract-version':'1'}}).then(function(r){
            if(r.ok&&r.data&&r.data.gameClips){
              G._buildTitleMap(r.data.gameClips);
              var rc=r.data.gameClips.map(function(c,i){return{id:2000+i,user:G.st.user,game:c.titleName||'Unknown',type:c.type||'Clip',title:c.clipName||c.titleName||'Gameplay',ai:G.scoreClip(c),lk:0,cm:0,sh:0,vw:c.views||0,dur:~~(c.durationInSeconds/60)+':'+String(~~(c.durationInSeconds%60)).padStart(2,'0'),ago:G.fmA(new Date(c.dateRecorded)),auto:c.type!=='UserGenerated',sd:i,thUrl:c.thumbnails&&c.thumbnails[0]?c.thumbnails[0].uri:null,vidUrl:c.gameClipUris&&c.gameClipUris[0]?c.gameClipUris[0].uri:null}});
              G.st.clips=rc;G.st.user.cl=rc.length;G.svClips();G.sv('glitch_sess',{user:G.st.user});G.render();
            }
          }).catch(function(e){console.log('Background refresh skipped:',e.message)});
        }
      } else {
        // No cache — show loading and fetch
        var auth=G.ld('glitch_xauth');
        if(auth){
          G.st.clipsLoading=true;G.render();
          G.px('https://gameclipsmetadata.xboxlive.com/users/me/clips',{method:'GET',headers:{'Authorization':'XBL3.0 x='+auth.uh+';'+auth.xt,'x-xbl-contract-version':'1'}}).then(function(r){
            if(r.ok&&r.data&&r.data.gameClips){
              G._buildTitleMap(r.data.gameClips);
              var rc=r.data.gameClips.map(function(c,i){return{id:2000+i,user:G.st.user,game:c.titleName||'Unknown',type:c.type||'Clip',title:c.clipName||c.titleName||'Gameplay',ai:G.scoreClip(c),lk:0,cm:0,sh:0,vw:c.views||0,dur:~~(c.durationInSeconds/60)+':'+String(~~(c.durationInSeconds%60)).padStart(2,'0'),ago:G.fmA(new Date(c.dateRecorded)),auto:c.type!=='UserGenerated',sd:i,thUrl:c.thumbnails&&c.thumbnails[0]?c.thumbnails[0].uri:null,vidUrl:c.gameClipUris&&c.gameClipUris[0]?c.gameClipUris[0].uri:null}});
              G.st.clips=rc;G.st.user.cl=rc.length;G.svClips();G.sv('glitch_sess',{user:G.st.user});
            }
            G.st.clipsLoading=false;G.render();
          }).catch(function(e){console.log('Clip fetch failed:',e.message);G.st.clipsLoading=false;G.render()});
        } else { G.render(); }
      }
    }
  } else{G.render()}
});
</script>
</body>
</html>
