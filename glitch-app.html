<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Glitch</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, sans-serif; background: #0c0a12; color: #eae8f0; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
.card { width: 100%; max-width: 400px; text-align: center; }
.logo { font-size: 48px; font-weight: 900; background: linear-gradient(135deg, #ff6b2b, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }
.sub { font-size: 13px; color: #7b6f94; letter-spacing: 3px; margin-bottom: 40px; }
.box { background: #13111d; border-radius: 16px; padding: 28px; border: 1px solid #ffffff0a; }
.box h2 { font-size: 18px; margin-bottom: 6px; }
.box p { font-size: 13px; color: #7b6f94; margin-bottom: 20px; line-height: 1.5; }
input { width: 100%; padding: 14px; background: #1c1928; border: 1px solid #ffffff15; border-radius: 12px; color: #eae8f0; font-size: 14px; outline: none; margin-bottom: 12px; font-family: monospace; }
input:focus { border-color: #ff6b2b; }
input::placeholder { color: #7b6f94; font-family: -apple-system, sans-serif; }
.btn { display: block; width: 100%; padding: 14px; border-radius: 12px; border: none; font-size: 15px; font-weight: 700; cursor: pointer; margin-bottom: 10px; transition: all 0.2s; text-decoration: none; text-align: center; }
.btn:active { transform: scale(0.97); }
.btn-xbox { background: linear-gradient(135deg, #ff6b2b22, #a855f722); border: 1px solid #ff6b2b55; color: #eae8f0; }
.btn-xbox.disabled { opacity: 0.3; pointer-events: none; }
.btn-demo { background: #1c1928; color: #7b6f94; border: 1px solid #ffffff10; }
.status { margin-top: 16px; padding: 12px; border-radius: 10px; font-size: 13px; display: none; word-break: break-all; line-height: 1.5; }
.status.error { display: block; background: #ff475715; border: 1px solid #ff475533; color: #ff6b6b; }
.status.success { display: block; background: #a855f715; border: 1px solid #a855f733; color: #a855f7; }
.status.info { display: block; background: #ff6b2b15; border: 1px solid #ff6b2b33; color: #ff6b2b; }
.profile { display: none; margin-top: 20px; padding: 20px; background: #13111d; border-radius: 16px; border: 1px solid #a855f733; }
.profile img { width: 64px; height: 64px; border-radius: 50%; border: 2px solid #a855f7; margin-bottom: 10px; }
.profile .gt { font-size: 22px; font-weight: 700; }
.profile .gs { font-size: 13px; color: #a855f7; margin-top: 4px; }
.debug { margin-top: 12px; text-align: left; font-size: 11px; color: #7b6f94; background: #1c1928; padding: 10px; border-radius: 8px; max-height: 200px; overflow-y: auto; word-break: break-all; font-family: monospace; line-height: 1.6; }
.redirect-info { margin-top: 12px; font-size: 11px; color: #7b6f94; background: #1c1928; padding: 10px; border-radius: 8px; word-break: break-all; font-family: monospace; text-align: left; }
</style>
</head>
<body>
<div class="card">
  <div class="logo">GLITCH</div>
  <div class="sub">XBOX LOGIN TEST</div>

  <div class="box" id="loginBox">
    <h2>Connect Xbox Account</h2>
    <p>Enter your Azure App Client ID, then tap the sign-in link below.</p>
    <input type="text" id="clientId" placeholder="Paste Client ID here...">
    <a id="xboxLink" href="#" class="btn btn-xbox disabled">Sign in with Xbox â†’</a>
    <button class="btn btn-demo" onclick="enterDemo()">Try Demo Mode</button>
    <div id="redirectInfo" class="redirect-info" style="display:none">
      <strong>Your redirect URI for Azure:</strong><br>
      <span id="redirectUri"></span>
    </div>
    <div id="status" class="status"></div>
  </div>

  <div class="profile" id="profile">
    <img id="profilePic" src="" alt="">
    <div class="gt" id="gamertag"></div>
    <div class="gs" id="gamerscore"></div>
    <div style="margin-top:16px;font-size:13px;color:#7b6f94">&#10003; Xbox connected successfully! The full Glitch app will work with your account.</div>
  </div>

  <div class="debug" id="debug" style="display:none"></div>
</div>

<script>
var REDIRECT_URI = window.location.origin + window.location.pathname;

// Show redirect URI so user can verify it matches Azure
document.getElementById('redirectUri').textContent = REDIRECT_URI;
document.getElementById('redirectInfo').style.display = 'block';

function log(msg) {
  var d = document.getElementById('debug');
  d.style.display = 'block';
  d.innerHTML += new Date().toLocaleTimeString() + ': ' + msg + '<br>';
  d.scrollTop = d.scrollHeight;
}

function setStatus(msg, type) {
  var s = document.getElementById('status');
  s.className = 'status ' + type;
  s.textContent = msg;
}

// Load saved client ID
var savedId = localStorage.getItem('glitch_cid');
if (savedId) {
  document.getElementById('clientId').value = savedId;
}

// PKCE helpers
function generateCodeVerifier() {
  var array = new Uint8Array(32);
  crypto.getRandomValues(array);
  return btoa(String.fromCharCode.apply(null, array))
    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

function sha256(plain) {
  var encoder = new TextEncoder();
  var data = encoder.encode(plain);
  return crypto.subtle.digest('SHA-256', data);
}

function base64urlencode(buf) {
  var str = '';
  var bytes = new Uint8Array(buf);
  for (var i = 0; i < bytes.byteLength; i++) {
    str += String.fromCharCode(bytes[i]);
  }
  return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

function updateLink() {
  var id = document.getElementById('clientId').value.trim();
  var link = document.getElementById('xboxLink');
  if (id && id.length > 10) {
    localStorage.setItem('glitch_cid', id);
    link.className = 'btn btn-xbox';
    // We'll build the URL on click, not here
    link.href = '#';
    link.onclick = function(e) {
      e.preventDefault();
      // Generate fresh PKCE verifier at click time
      var verifier = generateCodeVerifier();
      localStorage.setItem('glitch_pkce_verifier', verifier);
      sha256(verifier).then(function(hashed) {
        var challenge = base64urlencode(hashed);
        var url = 'https://login.live.com/oauth20_authorize.srf'
          + '?client_id=' + encodeURIComponent(id)
          + '&response_type=code'
          + '&redirect_uri=' + encodeURIComponent(REDIRECT_URI)
          + '&scope=' + encodeURIComponent('Xboxlive.signin Xboxlive.offline_access')
          + '&code_challenge=' + encodeURIComponent(challenge)
          + '&code_challenge_method=S256';
        window.location.href = url;
      });
    };
  } else {
    link.href = '#';
    link.onclick = null;
    link.className = 'btn btn-xbox disabled';
  }
}

document.getElementById('clientId').addEventListener('input', updateLink);
document.getElementById('clientId').addEventListener('change', updateLink);
updateLink();

// Check for OAuth callback on page load
var hash = window.location.hash;
var urlParams = new URLSearchParams(window.location.search);
var authCode = urlParams.get('code');

if (authCode) {
  // Authorization code flow
  history.replaceState(null, '', window.location.pathname);
  log('Got authorization code');
  setStatus('Got code! Exchanging for token...', 'info');
  
  var savedClientId = localStorage.getItem('glitch_cid');
  if (!savedClientId) {
    setStatus('Error: Client ID not found. Please paste it again and retry.', 'error');
  } else {
    exchangeCodeForToken(authCode, savedClientId);
  }
} else if (hash && hash.indexOf('access_token') !== -1) {
  var params = new URLSearchParams(hash.substring(1));
  var token = params.get('access_token');
  history.replaceState(null, '', window.location.pathname);

  if (token) {
    log('Got Microsoft access token');
    setStatus('Got token! Connecting to Xbox Live...', 'info');
    authenticateXbox(token);
  }
} else if (hash && hash.indexOf('error') !== -1) {
  var errParams = new URLSearchParams(hash.substring(1));
  var error = errParams.get('error');
  var desc = errParams.get('error_description');
  history.replaceState(null, '', window.location.pathname);
  log('OAuth error: ' + error + ' - ' + desc);
  setStatus('Error: ' + (desc || error), 'error');
} else if (urlParams.get('error')) {
  var error = urlParams.get('error');
  var desc = urlParams.get('error_description');
  history.replaceState(null, '', window.location.pathname);
  log('OAuth error: ' + error + ' - ' + desc);
  setStatus('Error: ' + (desc || error), 'error');
}

function exchangeCodeForToken(code, clientId) {
  log('Exchanging code for token...');
  
  var verifier = localStorage.getItem('glitch_pkce_verifier');
  if (!verifier) {
    setStatus('Error: PKCE verifier not found. Please try signing in again.', 'error');
    return;
  }
  
  var body = new URLSearchParams({
    client_id: clientId,
    code: code,
    redirect_uri: REDIRECT_URI,
    grant_type: 'authorization_code',
    scope: 'Xboxlive.signin Xboxlive.offline_access',
    code_verifier: verifier
  });

  fetch('https://login.live.com/oauth20_token.srf', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: body.toString()
  })
  .then(function(res) {
    if (!res.ok) return res.text().then(function(t) { throw new Error('Token exchange failed (' + res.status + '): ' + t); });
    return res.json();
  })
  .then(function(data) {
    if (data.access_token) {
      log('Got access token from code exchange');
      setStatus('Token received! Connecting to Xbox Live...', 'info');
      authenticateXbox(data.access_token);
    } else {
      throw new Error('No access_token in response: ' + JSON.stringify(data));
    }
  })
  .catch(function(err) {
    log('Token exchange error: ' + err.message);
    setStatus(err.message, 'error');
  });
}

function authenticateXbox(msToken) {
  log('Step 1: Getting Xbox Live token...');

  fetch('https://user.auth.xboxlive.com/user/authenticate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      RelyingParty: 'http://auth.xboxlive.com',
      TokenType: 'JWT',
      Properties: {
        AuthMethod: 'RPS',
        SiteName: 'user.auth.xboxlive.com',
        RpsTicket: 'd=' + msToken
      }
    })
  })
  .then(function(res) {
    if (!res.ok) return res.text().then(function(t) { throw new Error('XBL failed (' + res.status + '): ' + t); });
    return res.json();
  })
  .then(function(xblData) {
    var xblToken = xblData.Token;
    var userHash = xblData.DisplayClaims.xui[0].uhs;
    log('Step 1 done. User hash: ' + userHash);
    log('Step 2: Getting XSTS token...');

    return fetch('https://xsts.auth.xboxlive.com/xsts/authorize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        RelyingParty: 'http://xboxlive.com',
        TokenType: 'JWT',
        Properties: { SandboxId: 'RETAIL', UserTokens: [xblToken] }
      })
    })
    .then(function(res) {
      if (!res.ok) return res.text().then(function(t) { throw new Error('XSTS failed (' + res.status + '): ' + t); });
      return res.json();
    })
    .then(function(xstsData) {
      return { userHash: userHash, xstsToken: xstsData.Token };
    });
  })
  .then(function(auth) {
    log('Step 2 done. Getting profile...');

    return fetch(
      'https://profile.xboxlive.com/users/me/profile/settings?settings=Gamertag,GameDisplayPicRaw,Gamerscore',
      { headers: { 'Authorization': 'XBL3.0 x=' + auth.userHash + ';' + auth.xstsToken } }
    )
    .then(function(res) {
      if (!res.ok) return res.text().then(function(t) { throw new Error('Profile failed (' + res.status + '): ' + t); });
      return res.json();
    });
  })
  .then(function(profileData) {
    var settings = {};
    profileData.profileUsers[0].settings.forEach(function(s) { settings[s.id] = s.value; });
    log('Done! Gamertag: ' + settings.Gamertag);

    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('profile').style.display = 'block';
    document.getElementById('gamertag').textContent = settings.Gamertag;
    document.getElementById('gamerscore').textContent = settings.Gamerscore + ' Gamerscore';
    if (settings.GameDisplayPicRaw) {
      document.getElementById('profilePic').src = settings.GameDisplayPicRaw;
    }
    setStatus('Connected!', 'success');
  })
  .catch(function(err) {
    log('ERROR: ' + err.message);
    setStatus(err.message, 'error');
  });
}

function enterDemo() {
  document.getElementById('loginBox').style.display = 'none';
  document.getElementById('profile').style.display = 'block';
  document.getElementById('gamertag').textContent = 'DemoPlayer';
  document.getElementById('gamerscore').textContent = '12,450 Gamerscore';
  document.getElementById('profilePic').src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%231c1928' width='100' height='100'/%3E%3Ctext x='50' y='62' text-anchor='middle' font-size='40'%3E%F0%9F%8E%AE%3C/text%3E%3C/svg%3E";
}

log('Page loaded');
log('Redirect URI: ' + REDIRECT_URI);
</script>
</body>
</html>
