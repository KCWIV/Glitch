<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Glitch">
<meta name="theme-color" content="#0c0a12">
<title>Glitch</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@700;800;900&display=swap" rel="stylesheet">
<style>
:root{--a:#ff6b2b;--a2:#a855f7;--bg:#0c0a12;--c:#13111d;--sf:#1c1928;--t:#eae8f0;--d:#7b6f94;--r:#ff4757;--st:env(safe-area-inset-top,0px);--sb:env(safe-area-inset-bottom,0px)}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Rajdhani',sans-serif;background:var(--bg);color:var(--t);min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
input,button,textarea{font-family:inherit}button{cursor:pointer;border:none;background:none}::-webkit-scrollbar{width:0;height:0}
.app{max-width:480px;margin:0 auto;min-height:100dvh;position:relative}
@keyframes fu{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes fi{from{opacity:0}to{opacity:1}}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes pop{0%{transform:scale(.5);opacity:0}60%{transform:scale(1.1)}100%{transform:scale(1);opacity:1}}
.fu{animation:fu .4s ease both}.fi{animation:fi .3s ease both}
.d1{animation-delay:.05s;opacity:0}.d2{animation-delay:.1s;opacity:0}.d3{animation-delay:.15s;opacity:0}.d4{animation-delay:.2s;opacity:0}.d5{animation-delay:.25s;opacity:0}
.login{min-height:100dvh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;background:radial-gradient(ellipse at 50% 0%,#a855f70a 0%,transparent 50%),var(--bg)}
.logo{font-family:'Orbitron',sans-serif;font-size:48px;font-weight:900;background:linear-gradient(135deg,#ff6b2b,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.login-sub{font-size:13px;color:var(--d);letter-spacing:4px;text-transform:uppercase;font-weight:600;margin-bottom:40px}
.lcard{width:100%;max-width:380px;background:var(--c);border-radius:20px;border:1px solid #ffffff0a;padding:28px 24px}
.lcard h2{font-size:20px;font-weight:700;text-align:center;margin-bottom:6px}
.lcard p{font-size:13px;color:var(--d);text-align:center;margin-bottom:20px;line-height:1.4}
.linp{width:100%;padding:12px 14px;background:var(--sf);border:1px solid #ffffff11;border-radius:12px;color:var(--t);font-size:13px;outline:none;margin-bottom:10px}
.linp:focus{border-color:var(--a)}.linp::placeholder{color:var(--d)}
.lbl{font-size:11px;color:var(--d);font-weight:600;margin-bottom:4px;display:block}
.lb{display:block;width:100%;padding:15px;border-radius:14px;font-size:15px;font-weight:700;text-align:center;text-decoration:none;transition:all .3s}
.lb:active{transform:scale(.97)}
.lb-x{background:linear-gradient(135deg,#ff6b2b18,#a855f718);border:1px solid #ff6b2b44;color:var(--t);display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:10px}
.lb-x.off{opacity:.3;pointer-events:none}
.lb-d{background:#ffffff06;border:1px solid #ffffff10;color:var(--d);font-size:13px}
.ldiv{display:flex;align-items:center;gap:14px;margin:12px 0;color:var(--d);font-size:11px;font-weight:600;letter-spacing:1px}
.ldiv::before,.ldiv::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,transparent,#ffffff15,transparent)}
.lfeat{display:flex;gap:28px;justify-content:center;margin-top:36px}
.lfi{display:flex;flex-direction:column;align-items:center;gap:6px}
.lfi-i{width:44px;height:44px;border-radius:14px;background:#ff6b2b22;display:flex;align-items:center;justify-content:center;font-size:20px}
.lfi-l{font-size:10px;color:var(--d);font-weight:700;text-transform:uppercase}
.ls{margin-top:12px;padding:10px;border-radius:10px;font-size:12px;text-align:center;display:none;line-height:1.4}
.ls.on{display:block}.ls.info{background:#ff6b2b15;border:1px solid #ff6b2b33;color:var(--a)}.ls.err{background:#ff475715;border:1px solid #ff475533;color:#ff6b6b}.ls.ok{background:#a855f715;border:1px solid #a855f733;color:var(--a2)}
.tb{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;padding-top:calc(10px + var(--st));position:sticky;top:0;background:#0c0a12ee;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);z-index:100;border-bottom:1px solid #ffffff06}
.tb-l{font-family:'Orbitron',sans-serif;font-size:20px;font-weight:900;background:linear-gradient(135deg,#ff6b2b,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.tb-r{display:flex;align-items:center;gap:14px}
.ntf{position:relative;color:var(--d)}.ntf-d{position:absolute;top:-3px;right:-3px;width:14px;height:14px;border-radius:50%;background:var(--r);display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:800;color:#fff}
.avsm{width:30px;height:30px;border-radius:50%;background:var(--sf);display:flex;align-items:center;justify-content:center;font-size:15px;border:1.5px solid #ff6b2b33;overflow:hidden}.avsm img{width:100%;height:100%;object-fit:cover}
.bn{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;display:flex;align-items:flex-start;justify-content:space-around;padding:6px 0;padding-bottom:calc(8px + var(--sb));background:#0c0a12f8;border-top:1px solid #ffffff06;backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);z-index:100}
.ni{display:flex;flex-direction:column;align-items:center;gap:1px;padding:4px 14px;color:var(--d)}.ni.on{color:var(--a)}
.ni-l{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.3px}
.ni-u{width:46px;height:46px;border-radius:15px;background:var(--sf);border:1px solid #ffffff11;display:flex;align-items:center;justify-content:center;margin-top:-12px;color:var(--d)}.ni-u.on{background:var(--a);color:var(--bg);border:none;box-shadow:0 4px 24px #ff6b2b33}
.pg{padding-bottom:calc(76px + var(--sb))}.pt{font-size:22px;font-weight:800;padding:16px 16px 12px}
.tabs{display:flex;gap:6px;padding:14px 16px 8px;overflow-x:auto;scrollbar-width:none}
.tab{padding:7px 18px;border-radius:20px;font-size:13px;font-weight:700;white-space:nowrap;border:1px solid #ffffff0a;background:var(--sf);color:var(--d)}.tab.on{background:var(--a);color:var(--bg);border-color:var(--a)}
.feed{display:flex;flex-direction:column;gap:14px;padding:10px 14px}
.clip{background:var(--c);border-radius:18px;overflow:hidden;border:1px solid #ffffff08}.clip:active{transform:scale(.985)}
.cth{position:relative;width:100%;aspect-ratio:16/9;display:flex;align-items:center;justify-content:center;overflow:hidden;background-size:cover;background-position:center}
.cpl{position:absolute;width:56px;height:56px;border-radius:50%;background:#00000077;backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;padding-left:3px;opacity:.8}
.cdur{position:absolute;bottom:8px;right:8px;background:#000b;border-radius:6px;padding:2px 8px;font-size:12px;font-weight:700;color:#fff}
.cac{position:absolute;top:8px;left:8px;background:#a855f722;border:1px solid #a855f744;border-radius:6px;padding:2px 8px;font-size:10px;font-weight:700;color:var(--a2);display:flex;align-items:center;gap:4px;backdrop-filter:blur(6px)}
.cvw{position:absolute;bottom:8px;left:8px;display:flex;align-items:center;gap:4px;font-size:11px;color:#fffc;background:#0006;border-radius:6px;padding:2px 8px}
.cbd{padding:12px 14px 14px}.chd{display:flex;align-items:flex-start;justify-content:space-between;gap:8px}
.cur{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.cav{width:28px;height:28px;border-radius:50%;background:var(--sf);display:flex;align-items:center;justify-content:center;font-size:14px;border:1px solid #ffffff11;flex-shrink:0;overflow:hidden}.cav img{width:100%;height:100%;object-fit:cover}
.cun{font-size:13px;font-weight:700}.ctm{font-size:11px;color:var(--d)}.ctt{font-size:15px;font-weight:700;margin-bottom:5px;line-height:1.2}
.cgm{font-size:11px;color:var(--d);font-weight:600;background:var(--sf);border-radius:6px;padding:2px 8px;display:inline-block}
.ai{display:inline-flex;align-items:center;gap:4px;border-radius:20px;padding:3px 10px 3px 6px;font-size:11px;font-weight:700;letter-spacing:.5px;white-space:nowrap;flex-shrink:0}
.ai.s3{background:#ff475722;border:1px solid #ff475755;color:var(--r)}.ai.s2{background:#a855f722;border:1px solid #a855f755;color:var(--a2)}.ai.s1{background:#ff6b2b22;border:1px solid #ff6b2b55;color:var(--a)}
.cas{display:flex;align-items:center;gap:18px;margin-top:12px;padding-top:10px;border-top:1px solid #ffffff08}
.ca{display:flex;align-items:center;gap:5px;color:var(--d);font-size:13px;font-weight:600;padding:0}.ca.lk{color:var(--r)}
.sb{display:flex;align-items:center;gap:10px;background:var(--sf);border-radius:14px;padding:11px 14px;margin:0 16px 14px;border:1px solid #ffffff08}
.sb input{flex:1;background:none;border:none;outline:none;color:var(--t);font-size:14px}.sb input::placeholder{color:var(--d)}
.uc{display:flex;align-items:center;gap:12px;background:var(--c);border-radius:14px;padding:12px 14px;margin:0 16px 8px;border:1px solid #ffffff08}
.uav{width:46px;height:46px;border-radius:50%;background:var(--sf);display:flex;align-items:center;justify-content:center;font-size:22px;border:2px solid #ffffff11;flex-shrink:0}.uav.fl{border-color:#a855f733}
.ui{flex:1;min-width:0}.unr{display:flex;align-items:center;gap:6px}
.un{font-size:15px;font-weight:700}.xb{font-size:9px;font-weight:800;padding:1px 6px;border-radius:4px;letter-spacing:.5px;color:#107c10;background:#107c1022}
.ut{font-size:12px;color:var(--d)}.us{font-size:11px;color:var(--d);margin-top:2px}
.fb{padding:8px 18px;border-radius:10px;font-size:13px;font-weight:700;flex-shrink:0}.fb.fl{background:transparent;border:1px solid #a855f733;color:var(--a2)}.fb.nf{background:var(--a);color:var(--bg)}
.ph{background:linear-gradient(180deg,#a855f711 0%,transparent 100%);padding:28px 16px 16px;text-align:center}
.pav{width:84px;height:84px;border-radius:50%;margin:0 auto 12px;background:var(--sf);display:flex;align-items:center;justify-content:center;font-size:42px;border:3px solid #ff6b2b33;box-shadow:0 0 40px #ff6b2b22;overflow:hidden}.pav img{width:100%;height:100%;object-fit:cover}
.pnm{font-size:26px;font-weight:800}
.ptg{font-size:13px;color:var(--d);display:flex;align-items:center;justify-content:center;gap:6px;margin-top:4px}
.pss{display:flex;justify-content:center;gap:36px;margin-top:20px}
.pv{font-size:22px;font-weight:800}.pl{font-size:11px;color:var(--d);font-weight:600}
.ptabs{display:flex;border-bottom:1px solid #ffffff0a;padding:0 16px}
.ptb{flex:1;padding:12px 0;text-align:center;font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--d);border-bottom:2px solid transparent}.ptb.on{color:var(--t);border-bottom-color:var(--a)}
.sg{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:16px}
.sc{background:var(--c);border-radius:14px;padding:16px 14px;border:1px solid #ffffff08}
.sci{font-size:22px;margin-bottom:6px}.scv{font-size:20px;font-weight:800}.scl{font-size:11px;color:var(--d);font-weight:600}
.mt{display:flex;background:var(--sf);border-radius:14px;padding:4px;margin:0 16px 20px}
.mb{flex:1;padding:10px 0;border-radius:11px;font-size:14px;font-weight:700;color:var(--d)}.mb.on{background:var(--a);color:var(--bg)}
.syc{background:var(--c);border-radius:18px;padding:22px;margin:0 16px 14px;border:1px solid #ff6b2b33}
.syh{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.syi{width:44px;height:44px;border-radius:12px;background:#a855f722;display:flex;align-items:center;justify-content:center;font-size:20px}
.syt{font-size:16px;font-weight:700}.syd{font-size:12px;color:var(--d)}
.bsy{width:100%;padding:12px;border-radius:12px;background:var(--a);color:var(--bg);font-size:14px;font-weight:700}.bsy:active{transform:scale(.97)}
.pbr{height:8px;border-radius:4px;background:var(--sf);overflow:hidden;margin-bottom:8px}
.pfl{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--a),var(--a2))}
.aic{background:var(--c);border-radius:18px;padding:20px;margin:0 16px;border:1px solid #ffffff08}
.ait{font-size:16px;font-weight:700;margin-bottom:14px}
.air{display:flex;align-items:center;justify-content:space-between;padding:11px 0;border-bottom:1px solid #ffffff06}.air:last-child{border-bottom:none}
.ail{font-size:13px;font-weight:500;flex:1}
.tg{width:44px;height:24px;border-radius:12px;position:relative;flex-shrink:0}.tg.on{background:var(--a)}.tg.off{background:var(--sf);border:1px solid #ffffff11}
.tgk{width:18px;height:18px;border-radius:50%;background:#fff;position:absolute;top:3px;box-shadow:0 1px 3px rgba(0,0,0,.3)}.tg.on .tgk{left:23px}.tg.off .tgk{left:3px}
.mo{position:fixed;inset:0;background:#000d;z-index:200;display:flex;flex-direction:column;animation:fi .2s ease}
.mc{flex:1;max-width:480px;width:100%;margin:0 auto;background:var(--bg);display:flex;flex-direction:column;animation:su .3s ease;overflow-y:auto}
.mx{position:absolute;top:12px;right:12px;width:36px;height:36px;border-radius:50%;background:#000a;color:#fff;display:flex;align-items:center;justify-content:center;z-index:10}
.cs{padding:16px}.cr{display:flex;gap:10px;margin-top:14px;padding-top:14px;border-top:1px solid #ffffff08}
.ci2{flex:1;padding:10px 14px;background:var(--sf);border:1px solid #ffffff08;border-radius:20px;color:var(--t);font-size:13px;outline:none}.ci2:focus{border-color:#ff6b2b33}
.csb{padding:10px 18px;background:var(--a);color:var(--bg);border-radius:20px;font-size:13px;font-weight:700}
.cmi{display:flex;gap:10px;padding:10px 0}
.cmav{width:32px;height:32px;border-radius:50%;background:var(--sf);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.cmn{font-size:13px;font-weight:700}.cmt2{font-size:13px;color:var(--d);line-height:1.4;margin-top:2px}.cmtm{font-size:10px;color:var(--d);margin-top:3px}
.em{text-align:center;padding:40px 24px;color:var(--d)}.emi{font-size:44px;margin-bottom:12px}.emt{font-size:16px;font-weight:700;color:var(--t)}.emd{font-size:13px;margin-top:4px}
.gt{display:flex;flex-wrap:wrap;gap:8px;padding:0 16px}.gti{background:var(--c);border-radius:10px;padding:8px 14px;border:1px solid #ffffff08;font-size:13px;font-weight:600}
.lr{display:flex;align-items:center;gap:12px;padding:10px 16px;border-bottom:1px solid #ffffff05}
.lrk{font-size:16px;font-weight:800;color:var(--a2);width:26px;text-align:center}
.lra{width:38px;height:38px;border-radius:50%;background:var(--sf);display:flex;align-items:center;justify-content:center;font-size:18px}
.stt{font-size:13px;font-weight:700;color:var(--d);letter-spacing:1px;padding:0 16px;margin-bottom:10px;margin-top:20px}
.cli{display:flex;gap:12px;background:var(--c);border-radius:12px;overflow:hidden;margin:0 16px 8px;border:1px solid #ffffff08}
.clt{width:130px;min-height:74px;flex-shrink:0;position:relative;background-size:cover;background-position:center}
.clif{padding:10px 12px 10px 0;flex:1;min-width:0}
.cltt{font-size:14px;font-weight:700;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.clm{font-size:11px;color:var(--d)}
</style>
</head>
<body>
<div id="app" class="app"></div>
<script>
/*
 * GLITCH — Auth Flow (Implicit Grant via MSAL endpoint)
 *
 * 1. User clicks "Sign in with Xbox"
 * 2. Redirects to Microsoft login with response_type=token (implicit flow)
 * 3. Microsoft returns access_token directly in URL hash — NO code exchange needed
 * 4. App reads token from hash
 * 5. Uses PROXY for Xbox Live auth chain (XBL → XSTS → Profile → Clips)
 *
 * This eliminates the token exchange step entirely.
 * App must be registered as SPA in Azure (which it already is).
 */
var G={
REDIR:location.origin+location.pathname,
ic:function(n,z){z=z||20;var m={
home:'<svg width="'+z+'" height="'+z+'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
search:'<svg width="'+z+'" height="'+z+'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
upload:'<svg width="'+z+'" height="'+z+'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',
friends:'<svg width="'+z+'" height="'+z+'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
profile:'<svg width="'+z+'" height="'+z+'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
heart:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
heartF:'<svg width="18" height="18" viewBox="0 0 24 24" fill="#ff4757" stroke="#ff4757" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
cmt:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
share:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>',
play:'<svg width="32" height="32" viewBox="0 0 24 24" fill="white"><polygon points="5 3 19 12 5 21 5 3"/></svg>',
zap:'<svg width="14" height="14" viewBox="0 0 24 24" fill="var(--a)" stroke="var(--a)" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
bell:'<svg width="'+z+'" height="'+z+'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>',
x:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
eye:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
chk:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>',
out:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>'
};return m[n]||''},

USERS:[{id:1,un:"xNightHawk",gt:"xNightHawk#2847",av:"\u{1F985}",frs:1243,fg:89,cl:47},{id:2,un:"FragMaster99",gt:"FragMaster99",av:"\u{1F480}",frs:892,fg:134,cl:31},{id:3,un:"SilentScope",gt:"SilentScope_X",av:"\u{1F3AF}",frs:2301,fg:201,cl:63},{id:4,un:"VelocityKing",gt:"VelocityKing",av:"\u{26A1}",frs:567,fg:78,cl:22},{id:5,un:"LunarWraith",gt:"LunarWraith#1001",av:"\u{1F319}",frs:3102,fg:156,cl:89},{id:6,un:"BlazeRunner",gt:"BlazeRunner_TV",av:"\u{1F525}",frs:445,fg:62,cl:18}],
GAMES:["Call of Duty: MW3","Fortnite","Apex Legends","Halo Infinite","Rocket League","FIFA 25","GTA Online","Destiny 2","Overwatch 2","Diablo IV"],
TYPES:["Squad Wipe","Clutch Round","Insane Snipe","Ace","Trickshot","Collateral","1v4 Clutch","No-Scope","Team Play","Buzzer Beater"],
DCMTS:[{u:{av:"\u{1F480}",n:"FragMaster99"},t:"Absolutely filthy \u{1F525}",tm:"2m"},{u:{av:"\u{1F3AF}",n:"SilentScope"},t:"How do you hit those lol",tm:"8m"},{u:{av:"\u{26A1}",n:"VelocityKing"},t:"Bro I was in this lobby",tm:"14m"}],
HUES:[[200,260],[340,20],[140,200],[260,320],[20,80],[180,240],[300,360],[100,160],[220,280],[40,100]],

st:{screen:'login',page:'feed',user:null,clips:[],liked:new Set(),following:new Set([2,3,5]),comments:{},filter:'all clips',upMode:'auto',pTab:'clips',fTab:'friends',fSearch:'',syncProg:-1,selClip:null,newCmt:'',aiSet:[1,1,1,0,0]},
sv:function(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}},
ld:function(k){try{var v=localStorage.getItem(k);return v?JSON.parse(v):null}catch(e){return null}},
tg:function(s){var h=this.HUES[s%10];return'linear-gradient(135deg,hsl('+h[0]+',70%,20%),hsl('+h[1]+',80%,15%))'},
aib:function(s){return'<span class="ai '+(s>=90?'s3':s>=75?'s2':'s1')+'">'+this.ic('zap',14)+' '+s+' \u00b7 '+(s>=90?'INSANE':s>=75?'FIRE':'NICE')+'</span>'},
genClips:function(){var c=[];for(var i=0;i<20;i++){var u=this.USERS[~~(Math.random()*6)],g=this.GAMES[~~(Math.random()*10)],t=this.TYPES[~~(Math.random()*10)],sc=~~(Math.random()*40)+60,m=~~(Math.random()*1440);c.push({id:i+1,user:u,game:g,type:t,title:t+' on '+g,ai:sc,lk:~~(Math.random()*500)+10,cm:~~(Math.random()*80),sh:~~(Math.random()*40),vw:~~(Math.random()*5000)+100,dur:'0:'+String(~~(Math.random()*45)+5).padStart(2,'0'),ago:m<60?m+'m':m<1440?~~(m/60)+'h':~~(m/1440)+'d',auto:Math.random()>.3,sd:i})}this.st.clips=c.sort(function(a,b){return b.ai-a.ai})},

// === AUTH: Implicit flow — token comes back in URL hash, no exchange needed ===
px:function(url,opts){
  var proxy=localStorage.getItem('glitch_proxy');
  return fetch(proxy+'/api/xbox',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url:url,method:opts.method||'GET',headers:opts.headers||{},body:opts.body||undefined})}).then(function(r){return r.json()});
},

startLogin:function(){
  // Hardcoded — users don't need to configure anything
  var cid='c693c828-6bb7-43dc-a222-44d6e73c1130',proxy='https://glitch-proxy-sand.vercel.app';
  localStorage.setItem('glitch_cid',cid);
  localStorage.setItem('glitch_proxy',proxy);
  location.href='https://login.microsoftonline.com/consumers/oauth2/v2.0/authorize'
    +'?client_id='+encodeURIComponent(cid)
    +'&response_type=token'
    +'&redirect_uri='+encodeURIComponent(this.REDIR)
    +'&scope='+encodeURIComponent('Xboxlive.signin Xboxlive.offline_access')
    +'&response_mode=fragment'
    +'&nonce='+Date.now();
},

handleAuth:function(token){
  var self=this;
  self.setSt('Connecting to Xbox Live...','info');
  console.log('Got MS token, starting Xbox auth chain...');

  // Step 1: MS token -> XBL token (PROXY)
  self.px('https://user.auth.xboxlive.com/user/authenticate',{method:'POST',headers:{'Content-Type':'application/json'},body:{RelyingParty:'http://auth.xboxlive.com',TokenType:'JWT',Properties:{AuthMethod:'RPS',SiteName:'user.auth.xboxlive.com',RpsTicket:'d='+token}}})
  .then(function(r){
    if(!r.ok)throw new Error('XBL: '+JSON.stringify(r.data));
    var tk=r.data.Token,uh=r.data.DisplayClaims.xui[0].uhs;
    console.log('Step 1: Got XBL token');self.setSt('Authorizing...','info');

    // Step 2: XBL -> XSTS (PROXY)
    return self.px('https://xsts.auth.xboxlive.com/xsts/authorize',{method:'POST',headers:{'Content-Type':'application/json'},body:{RelyingParty:'http://xboxlive.com',TokenType:'JWT',Properties:{SandboxId:'RETAIL',UserTokens:[tk]}}}).then(function(r2){
      if(!r2.ok)throw new Error('XSTS: '+JSON.stringify(r2.data));
      console.log('Step 2: Got XSTS token');return{uh:uh,xt:r2.data.Token};
    });
  })
  .then(function(auth){
    self.setSt('Loading profile...','info');
    // Step 3: Profile (PROXY)
    return self.px('https://profile.xboxlive.com/users/me/profile/settings?settings=Gamertag,GameDisplayPicRaw,Gamerscore',{method:'GET',headers:{'Authorization':'XBL3.0 x='+auth.uh+';'+auth.xt,'x-xbl-contract-version':'2','Content-Type':'application/json'}}).then(function(r){
      if(!r.ok)throw new Error('Profile: '+JSON.stringify(r.data));
      console.log('Step 3: Got profile');return{p:r.data,a:auth};
    });
  })
  .then(function(res){
    var s={};res.p.profileUsers[0].settings.forEach(function(x){s[x.id]=x.value});
    self.st.user={id:0,un:s.Gamertag||'Player',gt:s.Gamertag||'Player',av:'\u{1F3AE}',avUrl:s.GameDisplayPicRaw||null,frs:0,fg:0,cl:0,gs:s.Gamerscore||'0'};
    self.st.screen='main';
    self.sv('glitch_sess',{user:self.st.user});
    self.sv('glitch_xauth',{uh:res.a.uh,xt:res.a.xt});
    console.log('SUCCESS: Logged in as',s.Gamertag);
    self.st.clips=[];self.render();

    // Step 4: Clips (PROXY, optional)
    self.px('https://gameclipsmetadata.xboxlive.com/users/me/clips',{method:'GET',headers:{'Authorization':'XBL3.0 x='+res.a.uh+';'+res.a.xt,'x-xbl-contract-version':'1'}}).then(function(r){
      if(r.ok&&r.data&&r.data.gameClips){
        var rc=r.data.gameClips.map(function(c,i){return{id:2000+i,user:self.st.user,game:c.titleName||'Unknown',type:c.type||'Clip',title:c.clipName||c.titleName||'Gameplay',ai:self.scoreClip(c),lk:0,cm:0,sh:0,vw:c.views||0,dur:~~(c.durationInSeconds/60)+':'+String(~~(c.durationInSeconds%60)).padStart(2,'0'),ago:self.fmA(new Date(c.dateRecorded)),auto:c.type!=='UserGenerated',sd:i,thUrl:c.thumbnails&&c.thumbnails[0]?c.thumbnails[0].uri:null,vidUrl:c.gameClipUris&&c.gameClipUris[0]?c.gameClipUris[0].uri:null}});
        self.st.clips=rc;self.st.user.cl=rc.length;console.log('Loaded',rc.length,'real clips');self.render();
      }
    }).catch(function(e){console.log('Clips optional:',e)});
  })
  .catch(function(e){console.error('Auth failed:',e.message);self.setSt('Error: '+e.message,'err');setTimeout(function(){self.demoFB()},4000)});
},

fmA:function(d){var m=~~((Date.now()-d.getTime())/60000);return m<60?m+'m':m<1440?~~(m/60)+'h':~~(m/1440)+'d'},

// Smart AI scoring based on clip metadata
scoreClip:function(c){
  var score=50,title=((c.clipName||'')+(c.titleName||'')).toLowerCase(),dur=c.durationInSeconds||30;
  // Duration scoring: sweet spot is 10-30s (highlights), very short or very long = lower
  if(dur>=5&&dur<=15)score+=15;else if(dur>15&&dur<=30)score+=12;else if(dur>30&&dur<=60)score+=6;else score+=2;
  // Game tier: competitive/action games score higher
  var tier1=['call of duty','halo','apex','overwatch','fortnite','valorant','rainbow six','destiny','gears','battlefield','counter-strike','pubg','warzone'];
  var tier2=['rocket league','fifa','nba','madden','ufc','gran turismo','forza','street fighter','mortal kombat'];
  var tier3=['gta','red dead','minecraft','roblox','diablo','elden ring','zelda','final fantasy','cyberpunk','starfield','hogwarts'];
  var gn=(c.titleName||'').toLowerCase();
  if(tier1.some(function(g){return gn.indexOf(g)!==-1}))score+=12;
  else if(tier2.some(function(g){return gn.indexOf(g)!==-1}))score+=8;
  else if(tier3.some(function(g){return gn.indexOf(g)!==-1}))score+=5;
  else score+=3;
  // Title keywords: action words boost score
  var hot=['kill','multi','triple','quad','penta','ace','clutch','wipe','squad','snipe','headshot','collateral','noscope','no-scope','trickshot','trick','win','victory','champion','mvp','record','insane','crazy','epic','best','impossible','unbelievable','1v'];
  var warm=['save','goal','assist','defend','capture','streak','spree','combo','finish','final','overtime','last','buzzer','comeback'];
  var hitHot=0,hitWarm=0;
  hot.forEach(function(k){if(title.indexOf(k)!==-1)hitHot++});
  warm.forEach(function(k){if(title.indexOf(k)!==-1)hitWarm++});
  score+=Math.min(hitHot*8,20)+Math.min(hitWarm*4,12);
  // Views boost (if Xbox provides them)
  var vw=c.views||0;
  if(vw>100)score+=5;if(vw>500)score+=5;if(vw>1000)score+=5;
  // User-saved clips (not auto) might be more intentional
  if(c.type==='UserGenerated')score+=5;
  // Clamp to 1-99
  return Math.max(1,Math.min(99,score));
},
demoFB:function(){this.st.user={id:0,un:'DemoPlayer',gt:'Demo Mode',av:'\u{1F3AE}',frs:1243,fg:89,cl:47};this.st.screen='main';this.sv('glitch_sess',{user:this.st.user,demo:1});this.genClips();this.render()},
setSt:function(m,t){var el=document.getElementById('ls');if(el){el.className='ls on '+t;el.textContent=m}},
loginDemo:function(){this.demoFB()},
logout:function(){localStorage.removeItem('glitch_sess');localStorage.removeItem('glitch_xauth');this.st.screen='login';this.st.user=null;this.render()},
toggleLike:function(id){var s=this.st.liked;s.has(id)?s.delete(id):s.add(id);this.render()},
toggleFollow:function(id){var s=this.st.following;s.has(id)?s.delete(id):s.add(id);this.render()},
toggleAI:function(i){this.st.aiSet[i]=this.st.aiSet[i]?0:1;this.render()},
startSync:function(){var self=this;this.st.syncProg=0;this.render();var iv=setInterval(function(){self.st.syncProg+=Math.random()*12+5;if(self.st.syncProg>=100){self.st.syncProg=100;clearInterval(iv)}self.render()},350)},
addCmt:function(){if(!this.st.newCmt.trim())return;var id=this.st.selClip.id;if(!this.st.comments[id])this.st.comments[id]=[];this.st.comments[id].unshift({u:{av:this.st.user.av,n:this.st.user.un},t:this.st.newCmt.trim(),tm:'now'});this.st.newCmt='';this.render()},

shareClip:function(c){
  var url=this.REDIR,text='Check out this '+c.game+' clip on Glitch! "'+c.title+'" \u2014 AI Score: '+c.ai;
  if(navigator.share){navigator.share({title:'Glitch \u2014 '+c.title,text:text,url:url}).catch(function(){})}
  else{navigator.clipboard.writeText(text+' '+url).then(function(){alert('Link copied!')}).catch(function(){prompt('Copy this link:',url)})}
},

shareApp:function(){
  var url=this.REDIR,text='Join me on Glitch \u2014 an AI-powered game clip app for Xbox players! Sign in with your Xbox account to share and score your best plays.';
  if(navigator.share){navigator.share({title:'Join Glitch',text:text,url:url}).catch(function(){})}
  else{navigator.clipboard.writeText(text+' '+url).then(function(){alert('Invite link copied!')}).catch(function(){prompt('Copy this link:',url)})}
},
// === RENDER ===
render:function(){document.getElementById('app').innerHTML=this.st.screen==='login'?this.rL():this.rM();this.bindAll()},
rL:function(){
  return'<div class="login"><div class="logo fu">GLITCH</div><div class="login-sub fu d1">AI-Powered Game Clips</div>'
  +'<div class="lcard fu d2"><h2>Welcome to Glitch</h2><p>Sign in with your Xbox account to import your game clips, get AI scores, and share your best plays</p>'
  +'<button id="xb" class="lb lb-x" style="margin-top:6px">\u{1F3AE} Sign in with Xbox</button>'
  +'<div class="ldiv">OR</div><button id="dm" class="lb lb-d">Explore Demo Mode \u2192</button>'
  +'<div id="ls" class="ls"></div></div></div>';
},
rM:function(){var p='';switch(this.st.page){case'feed':p=this.rF();break;case'discover':p=this.rD();break;case'upload':p=this.rU();break;case'friends':p=this.rFr();break;case'profile':p=this.rP();break}return this.rTB()+'<div class="pg">'+p+'</div>'+this.rBN()+(this.st.selClip?this.rMo(this.st.selClip):'')},
rTB:function(){var u=this.st.user,av=u.avUrl?'<img src="'+u.avUrl+'">':u.av;return'<div class="tb"><div class="tb-l">GLITCH</div><div class="tb-r"><button class="ntf">'+this.ic('bell')+'<span class="ntf-d">3</span></button><div class="avsm">'+av+'</div></div></div>'},
rBN:function(){var s=this,p=this.st.page,ns=[['feed','home','Feed'],['discover','search','Discover'],['upload','upload','Upload'],['friends','friends','Friends'],['profile','profile','Profile']];return'<div class="bn">'+ns.map(function(n){if(n[0]==='upload')return'<button class="ni" data-nav="'+n[0]+'"><div class="ni-u'+(p===n[0]?' on':'')+'">'+s.ic(n[1])+'</div><span class="ni-l">'+n[2]+'</span></button>';return'<button class="ni'+(p===n[0]?' on':'')+'" data-nav="'+n[0]+'">'+s.ic(n[1])+'<span class="ni-l">'+n[2]+'</span></button>'}).join('')+'</div>'},
rF:function(){var s=this,f=this.st.filter,cl=this.st.clips,isDemo=this.st.user&&this.st.user.un==='DemoPlayer';if(f==='auto-clips')cl=cl.filter(function(c){return c.auto});if(f==='top rated')cl=cl.slice().sort(function(a,b){return b.ai-a.ai});var tabs=isDemo?['trending','friends','auto-clips','top rated']:['all clips','top rated'];return'<div class="tabs">'+tabs.map(function(t){return'<button class="tab'+(f===t?' on':'')+'" data-f="'+t+'">'+t[0].toUpperCase()+t.slice(1)+'</button>'}).join('')+'</div>'+(cl.length>0?'<div class="feed">'+cl.map(function(c,i){return s.rC(c,i)}).join('')+'</div>':'<div class="em"><div class="emi">\u{1F3AE}</div><div class="emt">No clips yet</div><div class="emd">Your Xbox clips will appear here after syncing</div></div>')},
rC:function(c,i){var lk=this.st.liked.has(c.id),bg=c.thUrl?'background-image:url('+c.thUrl+')':'background:'+this.tg(c.sd);return'<div class="clip fu d'+(Math.min(i+1,5))+'"><div class="cth" style="'+bg+'" data-a="oc" data-id="'+c.id+'"><div class="cpl">'+this.ic('play',32)+'</div><span class="cdur">'+c.dur+'</span>'+(c.auto?'<span class="cac">'+this.ic('zap',12)+' AUTO</span>':'')+'<span class="cvw">'+this.ic('eye',12)+' '+c.vw.toLocaleString()+'</span></div><div class="cbd"><div class="chd"><div style="flex:1;min-width:0"><div class="cur"><div class="cav">'+(c.user.avUrl?'<img src="'+c.user.avUrl+'">':c.user.av)+'</div><span class="cun">'+c.user.un+'</span><span class="ctm">'+c.ago+'</span></div><div class="ctt">'+c.title+'</div><span class="cgm">'+c.game+'</span></div>'+this.aib(c.ai)+'</div><div class="cas"><button class="ca'+(lk?' lk':'')+'" data-a="lk" data-id="'+c.id+'">'+(lk?this.ic('heartF'):this.ic('heart'))+' '+(c.lk+(lk?1:0))+'</button><button class="ca" data-a="oc" data-id="'+c.id+'">'+this.ic('cmt')+' '+c.cm+'</button><button class="ca" data-a="sh" data-id="'+c.id+'">'+this.ic('share')+' Share</button></div></div></div>'},
rMo:function(c){var lk=this.st.liked.has(c.id),isDemo=this.st.user&&this.st.user.un==='DemoPlayer',cm=[].concat(this.st.comments[c.id]||[],isDemo?this.DCMTS:[]),bg=c.thUrl?'background-image:url('+c.thUrl+');background-size:cover;background-position:center':'background:'+this.tg(c.sd);var vidHtml=c.vidUrl?'<video id="clipVid" style="width:100%;aspect-ratio:16/9;background:#000;object-fit:contain" poster="'+(c.thUrl||'')+'" playsinline controls><source src="'+c.vidUrl+'" type="video/mp4"></video>':'<div class="cth" style="'+bg+'"><div class="cpl" data-a="noVid">'+this.ic('play',32)+'</div></div>';return'<div class="mo" data-a="cbg"><div class="mc" onclick="event.stopPropagation()"><div style="position:relative">'+vidHtml+'<button class="mx" data-a="cm">'+this.ic('x')+'</button></div><div style="padding:16px"><div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px"><div style="flex:1"><div class="ctt" style="font-size:18px">'+c.title+'</div><div style="display:flex;align-items:center;gap:8px;margin-top:6px"><div class="cav">'+(c.user.avUrl?'<img src="'+c.user.avUrl+'">':c.user.av)+'</div><span class="cun">'+c.user.un+'</span><span class="ctm">'+c.ago+'</span></div></div>'+this.aib(c.ai)+'</div><div class="cas" style="margin-top:16px;padding-top:14px"><button class="ca'+(lk?' lk':'')+'" data-a="lk" data-id="'+c.id+'">'+(lk?this.ic('heartF'):this.ic('heart'))+' '+(c.lk+(lk?1:0))+'</button><button class="ca">'+this.ic('cmt')+' '+(c.cm+(this.st.comments[c.id]||[]).length)+'</button><button class="ca" data-a="sh" data-id="'+c.id+'">'+this.ic('share')+' Share</button></div></div><div class="cs"><div style="font-size:15px;font-weight:700;margin-bottom:10px">Comments</div>'+(cm.length===0?'<div style="text-align:center;padding:20px 0;color:var(--d);font-size:13px">No comments yet \u2014 be the first!</div>':cm.map(function(m){return'<div class="cmi"><div class="cmav">'+m.u.av+'</div><div><div class="cmn">'+m.u.n+'</div><div class="cmt2">'+m.t+'</div><div class="cmtm">'+m.tm+'</div></div></div>'}).join(''))+'<div class="cr"><input class="ci2" id="ci" placeholder="Add a comment..." value="'+this.st.newCmt+'"><button class="csb" data-a="sc">Post</button></div></div></div></div>'},
rD:function(){var s=this,isDemo=this.st.user&&this.st.user.un==='DemoPlayer';return'<div class="pt">Discover</div><div class="sb">'+this.ic('search')+'<input placeholder="Search clips, games, players..."></div>'+(isDemo?'<div class="stt">\u{1F525} TRENDING GAMES</div><div class="gt">'+this.GAMES.map(function(g){return'<button class="gti">'+g+'</button>'}).join('')+'</div><div class="stt">\u{26A1} TOP CLIPPERS</div>'+this.USERS.slice(0,5).map(function(u,i){return'<div class="lr"><span class="lrk">#'+(i+1)+'</span><div class="lra">'+u.av+'</div><div style="flex:1"><div style="font-size:14px;font-weight:700">'+u.un+'</div><div style="font-size:11px;color:var(--d)">'+u.cl+' clips \u00b7 '+u.frs.toLocaleString()+' followers</div></div>'+s.aib(~~(Math.random()*15)+85)+'</div>'}).join(''):'<div class="em" style="margin-top:20px"><div class="emi">\u{1F50D}</div><div class="emt">Discover Players</div><div class="emd">Search for other gamertags to find and follow players. As more people join Glitch, trending clips and top players will appear here.</div></div>')},
rU:function(){var um=this.st.upMode,sp=this.st.syncProg,ai=this.st.aiSet,ls=["Detect multi-kills","Detect clutch rounds","Detect high-action","Detect trick shots","Auto-post 85+ clips"];return'<div class="pt">Upload</div><div class="mt"><button class="mb'+(um==='auto'?' on':'')+'" data-m="auto">\u{1F916} Auto</button><button class="mb'+(um==='manual'?' on':'')+'" data-m="manual">\u{1F4E4} Manual</button></div>'+(um==='auto'?'<div class="syc"><div class="syh"><div class="syi">\u{1F3AE}</div><div><div class="syt">Xbox Game DVR</div><div class="syd">Import captures from Xbox</div></div></div>'+(sp>=0?'<div class="pbr"><div class="pfl" style="width:'+Math.min(sp,100)+'%"></div></div><div style="font-size:12px;color:var(--d)">'+(sp>=100?'\u2705 Synced 8 clips!':'Syncing... '+~~(Math.min(sp,99))+'%')+'</div>':'<button class="bsy" data-a="sy">Sync Now</button>')+'</div><div class="aic"><div class="ait">\u{26A1} AI Settings</div>'+ls.map(function(l,i){return'<div class="air"><span class="ail">'+l+'</span><button class="tg '+(ai[i]?'on':'off')+'" data-a="ta" data-i="'+i+'"><div class="tgk"></div></button></div>'}).join('')+'</div>':'<div style="background:var(--c);border-radius:18px;padding:44px 24px;margin:0 16px;border:2px dashed #ffffff15;text-align:center"><div style="font-size:48px;margin-bottom:12px">\u{1F4E4}</div><div style="font-size:16px;font-weight:700">Upload a clip</div><div style="font-size:13px;color:var(--d);margin-top:4px;margin-bottom:20px">Choose from your captures</div><button class="bsy" style="width:auto;padding:10px 28px;display:inline-block">Choose File</button></div>')},
rFr:function(){var s=this,isDemo=this.st.user&&this.st.user.un==='DemoPlayer';if(!isDemo)return'<div class="pt">Friends</div><div class="sb">'+this.ic('search')+'<input placeholder="Search gamertags..."></div><div class="em" style="margin-top:10px"><div class="emi">\u{1F465}</div><div class="emt">No Friends Yet</div><div class="emd">Share Glitch with your Xbox friends so they can join, follow you, and see your clips!</div><button class="bsy" style="width:auto;padding:12px 28px;display:inline-block;margin-top:16px" data-a="invite">\u{1F4E8} Invite Friends</button></div>';var ft=this.st.fTab,fs=this.st.fSearch,fl=this.st.following,us=this.USERS.filter(function(u){return u.un.toLowerCase().indexOf(fs.toLowerCase())!==-1});if(ft==='friends')us=us.filter(function(u){return fl.has(u.id)});return'<div class="pt">Friends</div><div class="sb">'+this.ic('search')+'<input placeholder="Search gamertags..." id="fs" value="'+fs+'"></div><div class="tabs" style="padding-top:0">'+['friends','discover','requests'].map(function(t){return'<button class="tab'+(ft===t?' on':'')+'" data-ft="'+t+'">'+(t==='friends'?'Following':t[0].toUpperCase()+t.slice(1))+'</button>'}).join('')+'</div>'+(us.length===0?'<div class="em"><div class="emi">\u{1F465}</div><div class="emt">No results</div></div>':us.map(function(u){var f=fl.has(u.id);return'<div class="uc fu"><div class="uav'+(f?' fl':'')+'">'+u.av+'</div><div class="ui"><div class="unr"><span class="un">'+u.un+'</span><span class="xb">XBOX</span></div><div class="ut">'+u.gt+'</div><div class="us">'+u.cl+' clips \u00b7 '+u.frs.toLocaleString()+' followers</div></div><button class="fb'+(f?' fl':' nf')+'" data-a="fw" data-id="'+u.id+'">'+(f?s.ic('chk',14)+' Following':'Follow')+'</button></div>'}).join(''))},
rP:function(){var u=this.st.user,pt=this.st.pTab,s=this,cl=this.st.clips.filter(function(c){return c.user.id===u.id}),av=u.avUrl?'<img src="'+u.avUrl+'">':u.av;return'<div class="ph"><div class="pav">'+av+'</div><div class="pnm">'+u.un+'</div><div class="ptg"><span class="xb">XBOX</span> '+u.gt+(u.gs?' \u00b7 \u{1F3C6} '+u.gs:'')+'</div><div class="pss"><div style="text-align:center"><div class="pv">'+u.cl+'</div><div class="pl">Clips</div></div><div style="text-align:center"><div class="pv">'+u.frs.toLocaleString()+'</div><div class="pl">Followers</div></div><div style="text-align:center"><div class="pv">'+u.fg+'</div><div class="pl">Following</div></div></div><div style="display:flex;gap:8px;justify-content:center;margin-top:16px"><button style="padding:8px 20px;border-radius:10px;background:var(--a);color:var(--bg);font-size:13px;font-weight:700" data-a="invite">\u{1F4E8} Invite Friends</button><button style="padding:8px 16px;border-radius:10px;background:var(--sf);color:var(--r);border:1px solid #ffffff11;font-size:13px;font-weight:700" data-a="lo">'+this.ic('out',14)+' Logout</button></div></div><div class="ptabs">'+['clips','highlights','stats'].map(function(t){return'<button class="ptb'+(pt===t?' on':'')+'" data-pt="'+t+'">'+t.toUpperCase()+'</button>'}).join('')+'</div>'+(pt==='clips'?(cl.length>0?cl.map(function(c){var bg=c.thUrl?'background-image:url('+c.thUrl+')':'background:'+s.tg(c.sd);return'<div class="cli" data-a="oc" data-id="'+c.id+'"><div class="clt" style="'+bg+'"><span style="position:absolute;bottom:4px;right:4px;font-size:10px;color:#fff;background:#000a;border-radius:4px;padding:1px 5px">'+c.dur+'</span></div><div class="clif"><div class="cltt">'+c.title+'</div><div class="clm">'+c.game+' \u00b7 '+c.vw.toLocaleString()+' views</div><div style="margin-top:6px">'+s.aib(c.ai)+'</div></div></div>'}).join(''):'<div class="em"><div class="emi">\u{1F3AE}</div><div class="emt">No clips yet</div><div class="emd">Sync your Xbox captures</div></div>'):pt==='stats'?'<div class="sg">'+[{i:'\u{1F441}',v:cl.reduce(function(a,c){return a+c.vw},0).toLocaleString(),l:'Views'},{i:'\u{2764}',v:cl.reduce(function(a,c){return a+c.lk},0).toString(),l:'Likes'},{i:'\u{26A1}',v:cl.length>0?(cl.reduce(function(a,c){return a+c.ai},0)/cl.length).toFixed(1):'--',l:'Avg AI'},{i:'\u{1F3C6}',v:cl.length>0?Math.max.apply(null,cl.map(function(c){return c.ai})).toString():'--',l:'Best'},{i:'\u{1F3AE}',v:u.cl.toString(),l:'Clips'},{i:'\u{1F3AF}',v:u.gs||'--',l:'Gamerscore'}].map(function(x){return'<div class="sc"><div class="sci">'+x.i+'</div><div class="scv">'+x.v+'</div><div class="scl">'+x.l+'</div></div>'}).join('')+'</div>':'<div class="em"><div class="emi">\u{1F916}</div><div class="emt">AI Highlights Reel</div><div class="emd">Processing your gameplay...</div><div style="margin:20px auto 0;max-width:260px"><div class="pbr"><div class="pfl" style="width:67%"></div></div></div></div>')},
// === EVENTS ===
bindAll:function(){
  var s=this;
  document.querySelectorAll('[data-nav]').forEach(function(b){b.onclick=function(){s.st.page=b.dataset.nav;s.render()}});
  var xb=document.getElementById('xb');if(xb)xb.onclick=function(){s.startLogin()};
  var dm=document.getElementById('dm');if(dm)dm.onclick=function(){s.loginDemo()};
  document.querySelectorAll('[data-f]').forEach(function(b){b.onclick=function(){s.st.filter=b.dataset.f;s.render()}});
  document.querySelectorAll('[data-a="lk"]').forEach(function(b){b.onclick=function(e){e.stopPropagation();s.toggleLike(parseInt(b.dataset.id))}});
  document.querySelectorAll('[data-a="oc"]').forEach(function(b){b.onclick=function(){var c=s.st.clips.find(function(x){return x.id===parseInt(b.dataset.id)});if(c){s.st.selClip=c;s.render()}}});
  var cm=document.querySelector('[data-a="cm"]');if(cm)cm.onclick=function(){s.st.selClip=null;s.render()};
  var cbg=document.querySelector('[data-a="cbg"]');if(cbg)cbg.onclick=function(e){if(e.target===e.currentTarget){s.st.selClip=null;s.render()}};
  var sc=document.querySelector('[data-a="sc"]');if(sc)sc.onclick=function(){s.addCmt()};
  var cin=document.getElementById('ci');if(cin){cin.addEventListener('input',function(e){s.st.newCmt=e.target.value});cin.addEventListener('keydown',function(e){if(e.key==='Enter')s.addCmt()})}
  document.querySelectorAll('[data-a="fw"]').forEach(function(b){b.onclick=function(){s.toggleFollow(parseInt(b.dataset.id))}});
  document.querySelectorAll('[data-ft]').forEach(function(b){b.onclick=function(){s.st.fTab=b.dataset.ft;s.render()}});
  var fs=document.getElementById('fs');if(fs)fs.addEventListener('input',function(e){s.st.fSearch=e.target.value;s.render();setTimeout(function(){var el=document.getElementById('fs');if(el){el.focus();el.selectionStart=el.selectionEnd=el.value.length}},0)});
  document.querySelectorAll('[data-pt]').forEach(function(b){b.onclick=function(){s.st.pTab=b.dataset.pt;s.render()}});
  document.querySelectorAll('[data-m]').forEach(function(b){b.onclick=function(){s.st.upMode=b.dataset.m;s.render()}});
  var sy=document.querySelector('[data-a="sy"]');if(sy)sy.onclick=function(){s.startSync()};
  document.querySelectorAll('[data-a="ta"]').forEach(function(b){b.onclick=function(){s.toggleAI(parseInt(b.dataset.i))}});
  document.querySelectorAll('[data-a="sh"]').forEach(function(b){b.onclick=function(e){e.stopPropagation();var c=s.st.clips.find(function(x){return x.id===parseInt(b.dataset.id)});if(c)s.shareClip(c)}});
  document.querySelectorAll('[data-a="invite"]').forEach(function(b){b.onclick=function(){s.shareApp()}});
  var lo=document.querySelector('[data-a="lo"]');if(lo)lo.onclick=function(){s.logout()};
}
};

// === BOOT ===
document.addEventListener('DOMContentLoaded',function(){
  // Check URL hash for implicit flow token
  var hash=location.hash;
  if(hash&&hash.indexOf('access_token')!==-1){
    var params=new URLSearchParams(hash.substring(1));
    var token=params.get('access_token');
    history.replaceState(null,'',location.pathname);
    if(token){
      console.log('Got access_token from implicit flow');
      G.render(); // Show login screen with status
      G.handleAuth(token);
      return;
    }
  }
  // Check for error in hash
  if(hash&&hash.indexOf('error')!==-1){
    var ep=new URLSearchParams(hash.substring(1));
    history.replaceState(null,'',location.pathname);
    G.render();
    G.setSt('Error: '+(ep.get('error_description')||ep.get('error')),'err');
    return;
  }
  // Check saved session
  var sess=G.ld('glitch_sess');
  if(sess&&sess.user){G.st.user=sess.user;G.st.screen='main';G.genClips();G.render()}
  else{G.render()}
});
</script>
</body>
</html>
